<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Ethereal">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2025/08/06/rdma-learning/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="1. å®‰è£…ç¯å¢ƒ å®‰è£…æ‰©å±•å†…æ ¸æ¨¡å—  1sudo apt install linux-modules-extra-$(uname -r)   å®‰è£…rdma  RDMAï¼šSoft-RoCE ç¯å¢ƒæ­å»ºå®éªŒ   è¿è¡Œç¨‹åº  async-ucx&#x2F;.github&#x2F;workflows&#x2F;main.yml at main Â· madsys-dev&#x2F;async-ucx  123">
<meta property="og:type" content="article">
<meta property="og:title" content="RDMA learning">
<meta property="og:url" content="http://example.com/2025/08/06/RDMA-learning/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. å®‰è£…ç¯å¢ƒ å®‰è£…æ‰©å±•å†…æ ¸æ¨¡å—  1sudo apt install linux-modules-extra-$(uname -r)   å®‰è£…rdma  RDMAï¼šSoft-RoCE ç¯å¢ƒæ­å»ºå®éªŒ   è¿è¡Œç¨‹åº  async-ucx&#x2F;.github&#x2F;workflows&#x2F;main.yml at main Â· madsys-dev&#x2F;async-ucx  123">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-08-06T05:06:09.000Z">
<meta property="article:modified_time" content="2025-11-16T12:24:01.755Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            RDMA learning -
        
        Ethereal&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Welcome to Ethereal's Blog","subtitle":{"text":["A willing horse needs no spur."],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.2.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Github":{"path":"https://github.com/Ethereal-O/","icon":"fa-brands fa-github"},"CSDN":{"path":"https://blog.csdn.net/weixin_51969975","icon":"fa-brands fa-stack-overflow"},"Links":{"icon":"fa-regular fa-link","submenus":{"Fontawesome":"https://fontawesome.com/search","Iconfont":"https://www.iconfont.cn/","Redefine":"https://redefine-docs.ohevan.com/introduction","Linyu":"https://www.linyu.cool/","Electronic-Waste":"https://blog.electronicwaste.cn/?","Thysrael":"https://thysrael.github.io/?","World-explorer":"https://www.cnblogs.com/world-explorer"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/8/1 00:00:00"};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Ethereal&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    target="_blank" rel="noopener" href="https://github.com/Ethereal-O/"  >
                                    
                                        
                                            <i class="fa-brands fa-github"></i>
                                        
                                        GITHUB
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_51969975"  >
                                    
                                        
                                            <i class="fa-brands fa-stack-overflow"></i>
                                        
                                        CSDN
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-link"></i>
                                        
                                        LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://fontawesome.com/search">FONTAWESOME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.iconfont.cn/">ICONFONT
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://redefine-docs.ohevan.com/introduction">REDEFINE
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.linyu.cool/">LINYU
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://blog.electronicwaste.cn/?">ELECTRONIC-WASTE
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://thysrael.github.io/?">THYSRAEL
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.cnblogs.com/world-explorer">WORLD-EXPLORER
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        target="_blank" rel="noopener" href="https://github.com/Ethereal-O/"  >
                             
                                
                                    <i class="fa-brands fa-github"></i>
                                
                                GITHUB
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_51969975"  >
                             
                                
                                    <i class="fa-brands fa-stack-overflow"></i>
                                
                                CSDN
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-link"></i>
                                
                                LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://fontawesome.com/search">FONTAWESOME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.iconfont.cn/">ICONFONT</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://redefine-docs.ohevan.com/introduction">REDEFINE</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.linyu.cool/">LINYU</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://blog.electronicwaste.cn/?">ELECTRONIC-WASTE</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://thysrael.github.io/?">THYSRAEL</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.cnblogs.com/world-explorer">WORLD-EXPLORER</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">RDMA learning</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/favicon.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Ethereal</span>
                            
                                <span class="author-label">Lv5</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-08-06 13:06:09</span>
        <span class="mobile">2025-08-06 13:06</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-11-16 20:24:01</span>
            <span class="mobile">2025-11-16 20:24</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h2 id="1-å®‰è£…ç¯å¢ƒ"><a href="#1-å®‰è£…ç¯å¢ƒ" class="headerlink" title="1. å®‰è£…ç¯å¢ƒ"></a>1. å®‰è£…ç¯å¢ƒ</h2><ol>
<li>å®‰è£…æ‰©å±•å†…æ ¸æ¨¡å—</li>
</ol>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install linux-modules-extra-$(uname -r)</span><br></pre></td></tr></table></figure></div>

<ol start="2">
<li>å®‰è£…rdma</li>
</ol>
<p><a class="link"   target="_blank" rel="noopener" href="https://cuterwrite.top/p/soft-roce/" >RDMAï¼šSoft-RoCE ç¯å¢ƒæ­å»ºå®éªŒ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ol start="3">
<li>è¿è¡Œç¨‹åº</li>
</ol>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/madsys-dev/async-ucx/blob/main/.github/workflows/main.yml" >async-ucx&#x2F;.github&#x2F;workflows&#x2F;main.yml at main Â· madsys-dev&#x2F;async-ucx <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><span class="line">. &quot;$HOME/.cargo/env&quot;</span><br><span class="line">sudo apt-get -y install pkg-config gcc g++ autoconf</span><br><span class="line">sudo apt-get -y install clang</span><br><span class="line">sudo apt-get -y install ucx-utils libucx-dev</span><br><span class="line">cargo build  --all-features --all-targets</span><br><span class="line">cargo test  --all-features</span><br></pre></td></tr></table></figure></div>

<p><a class="link"   target="_blank" rel="noopener" href="https://gitee.com/wq897/RDMA-EXAMPLE/blob/master/01/service.c" >01&#x2F;service.c Â· wq&#x2F;RDMA-EXAMPLE - ç äº‘ - å¼€æºä¸­å›½ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./async-ucx/target/debug/examples/rma</span><br><span class="line">./async-ucx/target/debug/examples/rma </span><br></pre></td></tr></table></figure></div>

<h2 id="2-å•è¾¹ä¸åŒè¾¹"><a href="#2-å•è¾¹ä¸åŒè¾¹" class="headerlink" title="2. å•è¾¹ä¸åŒè¾¹"></a>2. å•è¾¹ä¸åŒè¾¹</h2><p>RDMAå•è¾¹å’ŒåŒè¾¹æ“ä½œåœ¨ä»£ç ç¼–å†™ä¸Šæœ‰æ˜¾è‘—å·®å¼‚ï¼Œä¸»è¦ä½“ç°åœ¨æ“ä½œæ–¹å¼ã€å†…å­˜ç®¡ç†å’Œé€šä¿¡æ¨¡å¼ç­‰æ–¹é¢ã€‚</p>
<h3 id="ğŸ“Š-æ ¸å¿ƒå·®å¼‚å¯¹æ¯”"><a href="#ğŸ“Š-æ ¸å¿ƒå·®å¼‚å¯¹æ¯”" class="headerlink" title="ğŸ“Š æ ¸å¿ƒå·®å¼‚å¯¹æ¯”"></a>ğŸ“Š æ ¸å¿ƒå·®å¼‚å¯¹æ¯”</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å•è¾¹æ“ä½œ(One-Sided)</th>
<th>åŒè¾¹æ“ä½œ(Two-Sided)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¿œç¨‹CPUå‚ä¸</strong></td>
<td>ä¸éœ€è¦</td>
<td>å¿…éœ€</td>
</tr>
<tr>
<td><strong>æ“ä½œç±»å‹</strong></td>
<td>RDMA Write&#x2F;Read&#x2F;Atomic</td>
<td>SEND&#x2F;RECV</td>
</tr>
<tr>
<td><strong>å†…å­˜ç®¡ç†</strong></td>
<td>éœ€è¦äº¤æ¢å†…å­˜å…ƒæ•°æ®</td>
<td>ä¸éœ€è¦å†…å­˜å…ƒæ•°æ®äº¤æ¢</td>
</tr>
<tr>
<td><strong>é€šä¿¡æ¨¡å¼</strong></td>
<td>å•å‘ç›´æ¥å†…å­˜è®¿é—®</td>
<td>åŒå‘æ¶ˆæ¯ä¼ é€’</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>å»¶è¿Ÿæ›´ä½</td>
<td>å»¶è¿Ÿè¾ƒé«˜</td>
</tr>
<tr>
<td><strong>å¤æ‚æ€§</strong></td>
<td>è®¾ç½®æ›´å¤æ‚</td>
<td>ç›¸å¯¹ç®€å•</td>
</tr>
</tbody></table>
<h3 id="ğŸ”§-ä»£ç å±‚é¢çš„å…·ä½“å·®å¼‚"><a href="#ğŸ”§-ä»£ç å±‚é¢çš„å…·ä½“å·®å¼‚" class="headerlink" title="ğŸ”§ ä»£ç å±‚é¢çš„å…·ä½“å·®å¼‚"></a>ğŸ”§ ä»£ç å±‚é¢çš„å…·ä½“å·®å¼‚</h3><h4 id="1-æ“ä½œç±»å‹å’Œè¯­ä¹‰å·®å¼‚"><a href="#1-æ“ä½œç±»å‹å’Œè¯­ä¹‰å·®å¼‚" class="headerlink" title="1. æ“ä½œç±»å‹å’Œè¯­ä¹‰å·®å¼‚"></a>1. æ“ä½œç±»å‹å’Œè¯­ä¹‰å·®å¼‚</h4><h5 id="åŒè¾¹æ“ä½œ-Two-Sided-SEND-x2F-RECV"><a href="#åŒè¾¹æ“ä½œ-Two-Sided-SEND-x2F-RECV" class="headerlink" title="åŒè¾¹æ“ä½œ(Two-Sided) - SEND&#x2F;RECV"></a>åŒè¾¹æ“ä½œ(Two-Sided) - SEND&#x2F;RECV</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘é€æ–¹ - å‘å¸ƒSENDæ“ä½œ</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ibv_send_wr</span> send_wr;</span><br><span class="line"><span class="built_in">memset</span>(&amp;send_wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(send_wr));</span><br><span class="line">send_wr.wr_id = <span class="number">1</span>;</span><br><span class="line">send_wr.opcode = IBV_WR_SEND;  <span class="comment">// å‘é€æ“ä½œ</span></span><br><span class="line">send_wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"><span class="comment">// ... è®¾ç½®sg_listç­‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥æ”¶æ–¹ - å¿…é¡»å‘å¸ƒRECVæ“ä½œæ¥åŒ¹é…</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ibv_recv_wr</span> recv_wr; </span><br><span class="line"><span class="built_in">memset</span>(&amp;recv_wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(recv_wr));</span><br><span class="line">recv_wr.wr_id = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// ... è®¾ç½®æ¥æ”¶ç¼“å†²åŒº</span></span><br></pre></td></tr></table></figure></div>

<h5 id="å•è¾¹æ“ä½œ-One-Sided-RDMA-WRITE"><a href="#å•è¾¹æ“ä½œ-One-Sided-RDMA-WRITE" class="headerlink" title="å•è¾¹æ“ä½œ(One-Sided) - RDMA WRITE"></a>å•è¾¹æ“ä½œ(One-Sided) - RDMA WRITE</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘èµ·æ–¹ - RDMA WRITEæ“ä½œ</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ibv_send_wr</span> send_wr;</span><br><span class="line"><span class="built_in">memset</span>(&amp;send_wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(send_wr));</span><br><span class="line">send_wr.wr_id = <span class="number">1</span>;</span><br><span class="line">send_wr.opcode = IBV_WR_RDMA_WRITE;  <span class="comment">// å•è¾¹å†™å…¥æ“ä½œ</span></span><br><span class="line">send_wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line">send_wr.wr.rdma.remote_addr = remote_addr;  <span class="comment">// è¿œç¨‹å†…å­˜åœ°å€</span></span><br><span class="line">send_wr.wr.rdma.rkey = remote_rkey;         <span class="comment">// è¿œç¨‹å†…å­˜å¯†é’¥</span></span><br><span class="line"><span class="comment">// ... ä¸éœ€è¦è¿œç¨‹ç«¯å‘å¸ƒä»»ä½•æ“ä½œ</span></span><br></pre></td></tr></table></figure></div>

<h4 id="2-å†…å­˜ç®¡ç†å·®å¼‚"><a href="#2-å†…å­˜ç®¡ç†å·®å¼‚" class="headerlink" title="2. å†…å­˜ç®¡ç†å·®å¼‚"></a>2. å†…å­˜ç®¡ç†å·®å¼‚</h4><h5 id="åŒè¾¹æ“ä½œ-ç®€å•çš„ç¼“å†²åŒºæ³¨å†Œ"><a href="#åŒè¾¹æ“ä½œ-ç®€å•çš„ç¼“å†²åŒºæ³¨å†Œ" class="headerlink" title="åŒè¾¹æ“ä½œ - ç®€å•çš„ç¼“å†²åŒºæ³¨å†Œ"></a>åŒè¾¹æ“ä½œ - ç®€å•çš„ç¼“å†²åŒºæ³¨å†Œ</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒè¾¹æ“ä½œåªéœ€è¦æ³¨å†Œæœ¬åœ°ä½¿ç”¨çš„å†…å­˜</span></span><br><span class="line"><span class="type">char</span>* send_buffer = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line"><span class="type">char</span>* recv_buffer = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* send_mr = <span class="built_in">ibv_reg_mr</span>(pd, send_buffer, BUFFER_SIZE,</span><br><span class="line">                                   IBV_ACCESS_LOCAL_WRITE);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* recv_mr = <span class="built_in">ibv_reg_mr</span>(pd, recv_buffer, BUFFER_SIZE,</span><br><span class="line">                                   IBV_ACCESS_LOCAL_WRITE);</span><br></pre></td></tr></table></figure></div>

<h5 id="å•è¾¹æ“ä½œ-éœ€è¦å†…å­˜å…ƒæ•°æ®äº¤æ¢"><a href="#å•è¾¹æ“ä½œ-éœ€è¦å†…å­˜å…ƒæ•°æ®äº¤æ¢" class="headerlink" title="å•è¾¹æ“ä½œ - éœ€è¦å†…å­˜å…ƒæ•°æ®äº¤æ¢"></a>å•è¾¹æ“ä½œ - éœ€è¦å†…å­˜å…ƒæ•°æ®äº¤æ¢</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•è¾¹æ“ä½œéœ€è¦äº¤æ¢å†…å­˜å…ƒæ•°æ®</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MemoryMetadata</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> address;  <span class="comment">// å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="type">uint32_t</span> rkey;     <span class="comment">// è¿œç¨‹å¯†é’¥</span></span><br><span class="line">    <span class="type">uint32_t</span> length;   <span class="comment">// å†…å­˜é•¿åº¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœåŠ¡å™¨æ³¨å†Œå¹¶å‘å¸ƒå†…å­˜ä¾›å®¢æˆ·ç«¯å†™å…¥</span></span><br><span class="line"><span class="type">char</span>* server_buffer = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* server_mr = <span class="built_in">ibv_reg_mr</span>(pd, server_buffer, BUFFER_SIZE,</span><br><span class="line">                                     IBV_ACCESS_LOCAL_WRITE | </span><br><span class="line">                                     IBV_ACCESS_REMOTE_WRITE);  <span class="comment">// å…è®¸è¿œç¨‹å†™å…¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡åŒè¾¹æ“ä½œäº¤æ¢å†…å­˜å…ƒæ•°æ®</span></span><br><span class="line">MemoryMetadata server_metadata;</span><br><span class="line">server_metadata.address = (<span class="type">uint64_t</span>)server_buffer;</span><br><span class="line">server_metadata.rkey = server_mr-&gt;rkey;</span><br><span class="line">server_metadata.length = BUFFER_SIZE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€å†…å­˜å…ƒæ•°æ®ç»™å¯¹ç«¯</span></span><br><span class="line"><span class="built_in">send_metadata_to_peer</span>(server_metadata);</span><br></pre></td></tr></table></figure></div>

<h4 id="3-å®Œæ•´çš„ä»£ç ç¤ºä¾‹å¯¹æ¯”"><a href="#3-å®Œæ•´çš„ä»£ç ç¤ºä¾‹å¯¹æ¯”" class="headerlink" title="3. å®Œæ•´çš„ä»£ç ç¤ºä¾‹å¯¹æ¯”"></a>3. å®Œæ•´çš„ä»£ç ç¤ºä¾‹å¯¹æ¯”</h4><h5 id="åŒè¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹"><a href="#åŒè¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹" class="headerlink" title="åŒè¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹"></a>åŒè¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒè¾¹æ“ä½œ - å®Œæ•´çš„SEND/RECVæµç¨‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoSidedRDMA</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp</span>* qp;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* send_mr, *recv_mr;</span><br><span class="line">    <span class="type">char</span>* send_buf, *recv_buf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œå†…å­˜ - ç›¸å¯¹ç®€å•</span></span><br><span class="line">        send_buf = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line">        recv_buf = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line">        send_mr = <span class="built_in">ibv_reg_mr</span>(pd, send_buf, BUFFER_SIZE, IBV_ACCESS_LOCAL_WRITE);</span><br><span class="line">        recv_mr = <span class="built_in">ibv_reg_mr</span>(pd, recv_buf, BUFFER_SIZE, IBV_ACCESS_LOCAL_WRITE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">post_receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¿…é¡»é¢„å…ˆå‘å¸ƒæ¥æ”¶è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_recv_wr</span> wr, *bad_wr;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">        sge.addr = (<span class="type">uintptr_t</span>)recv_buf;</span><br><span class="line">        sge.length = BUFFER_SIZE;</span><br><span class="line">        sge.lkey = recv_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">        wr.wr_id = <span class="number">0</span>;</span><br><span class="line">        wr.next = <span class="literal">NULL</span>;</span><br><span class="line">        wr.sg_list = &amp;sge;</span><br><span class="line">        wr.num_sge = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ibv_post_recv</span>(qp, &amp;wr, &amp;bad_wr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">send_message</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¤åˆ¶æ•°æ®åˆ°å‘é€ç¼“å†²åŒº</span></span><br><span class="line">        <span class="built_in">strcpy</span>(send_buf, message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_send_wr</span> wr, *bad_wr;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">        sge.addr = (<span class="type">uintptr_t</span>)send_buf;</span><br><span class="line">        sge.length = <span class="built_in">strlen</span>(message) + <span class="number">1</span>;</span><br><span class="line">        sge.lkey = send_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">        wr.wr_id = <span class="number">1</span>;</span><br><span class="line">        wr.next = <span class="literal">NULL</span>;</span><br><span class="line">        wr.sg_list = &amp;sge;</span><br><span class="line">        wr.num_sge = <span class="number">1</span>;</span><br><span class="line">        wr.opcode = IBV_WR_SEND;  <span class="comment">// åŒè¾¹å‘é€æ“ä½œ</span></span><br><span class="line">        wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ibv_post_send</span>(qp, &amp;wr, &amp;bad_wr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h5 id="å•è¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹"><a href="#å•è¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹" class="headerlink" title="å•è¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹"></a>å•è¾¹æ“ä½œå®Œæ•´ç¤ºä¾‹</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•è¾¹æ“ä½œ - å®Œæ•´çš„RDMA WRITEæµç¨‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OneSidedRDMA</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp</span>* qp;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* local_mr, *remote_mr;</span><br><span class="line">    <span class="type">char</span>* local_buf, *remote_buf;</span><br><span class="line">    MemoryMetadata remote_metadata;  <span class="comment">// éœ€è¦å­˜å‚¨è¿œç¨‹å†…å­˜ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œæœ¬åœ°å†…å­˜</span></span><br><span class="line">        local_buf = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line">        local_mr = <span class="built_in">ibv_reg_mr</span>(pd, local_buf, BUFFER_SIZE, </span><br><span class="line">                             IBV_ACCESS_LOCAL_WRITE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è·å–è¿œç¨‹å†…å­˜ä¿¡æ¯</span></span><br><span class="line">        <span class="built_in">exchange_memory_metadata</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">exchange_memory_metadata</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¿™æ˜¯å…³é”®å·®å¼‚ï¼šéœ€è¦äº¤æ¢å†…å­˜å…ƒæ•°æ®</span></span><br><span class="line">        <span class="comment">// é€šå¸¸ä½¿ç”¨åŒè¾¹æ“ä½œæˆ–å¸¦å†…æ•°æ®æ¥å®Œæˆ</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨å†Œä¾›è¿œç¨‹è®¿é—®çš„å†…å­˜</span></span><br><span class="line">        remote_buf = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line">        remote_mr = <span class="built_in">ibv_reg_mr</span>(pd, remote_buf, BUFFER_SIZE,</span><br><span class="line">                              IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_WRITE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¹¶å‘é€å†…å­˜å…ƒæ•°æ®</span></span><br><span class="line">        MemoryMetadata my_metadata;</span><br><span class="line">        my_metadata.address = (<span class="type">uint64_t</span>)remote_buf;</span><br><span class="line">        my_metadata.rkey = remote_mr-&gt;rkey;</span><br><span class="line">        my_metadata.length = BUFFER_SIZE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨åŒè¾¹æ“ä½œå‘é€å…ƒæ•°æ®</span></span><br><span class="line">        <span class="built_in">send_metadata_via_two_sided</span>(my_metadata);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥æ”¶è¿œç¨‹å†…å­˜å…ƒæ•°æ®</span></span><br><span class="line">        remote_metadata = <span class="built_in">receive_metadata_via_two_sided</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">rdma_write</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* data)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¤åˆ¶æ•°æ®åˆ°æœ¬åœ°ç¼“å†²åŒº</span></span><br><span class="line">        <span class="built_in">strcpy</span>(local_buf, data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_send_wr</span> wr, *bad_wr;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">        sge.addr = (<span class="type">uintptr_t</span>)local_buf;</span><br><span class="line">        sge.length = <span class="built_in">strlen</span>(data) + <span class="number">1</span>;</span><br><span class="line">        sge.lkey = local_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">        wr.wr_id = <span class="number">1</span>;</span><br><span class="line">        wr.next = <span class="literal">NULL</span>;</span><br><span class="line">        wr.sg_list = &amp;sge;</span><br><span class="line">        wr.num_sge = <span class="number">1</span>;</span><br><span class="line">        wr.opcode = IBV_WR_RDMA_WRITE;  <span class="comment">// å•è¾¹å†™å…¥æ“ä½œ</span></span><br><span class="line">        wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é”®ï¼šè®¾ç½®è¿œç¨‹å†…å­˜ä¿¡æ¯</span></span><br><span class="line">        wr.wr.rdma.remote_addr = remote_metadata.address;</span><br><span class="line">        wr.wr.rdma.rkey = remote_metadata.rkey;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ibv_post_send</span>(qp, &amp;wr, &amp;bad_wr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¿œç¨‹ç«¯å†™å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">get_remote_data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> remote_buf;  <span class="comment">// ç›´æ¥è®¿é—®æœ¬åœ°æ˜ å°„çš„ç¼“å†²åŒº</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h4 id="4-è¿æ¥å»ºç«‹å’ŒQPè®¾ç½®çš„å·®å¼‚"><a href="#4-è¿æ¥å»ºç«‹å’ŒQPè®¾ç½®çš„å·®å¼‚" class="headerlink" title="4. è¿æ¥å»ºç«‹å’ŒQPè®¾ç½®çš„å·®å¼‚"></a>4. è¿æ¥å»ºç«‹å’ŒQPè®¾ç½®çš„å·®å¼‚</h4><h5 id="åŒè¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—"><a href="#åŒè¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—" class="headerlink" title="åŒè¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—"></a>åŒè¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒè¾¹æ“ä½œ - ç›¸å¯¹ç®€å•çš„è®¿é—®æƒé™</span></span><br><span class="line">qp_attr.qp_access_flags = IBV_ACCESS_LOCAL_WRITE;</span><br></pre></td></tr></table></figure></div>

<h5 id="å•è¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—"><a href="#å•è¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—" class="headerlink" title="å•è¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—"></a>å•è¾¹æ“ä½œçš„QPè®¿é—®æ ‡å¿—</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•è¾¹æ“ä½œ - éœ€è¦æ›´å¹¿æ³›çš„è®¿é—®æƒé™</span></span><br><span class="line">qp_attr.qp_access_flags = IBV_ACCESS_LOCAL_WRITE | </span><br><span class="line">                         IBV_ACCESS_REMOTE_READ | </span><br><span class="line">                         IBV_ACCESS_REMOTE_WRITE;</span><br></pre></td></tr></table></figure></div>

<h4 id="5-å®Œæˆäº‹ä»¶å¤„ç†çš„å·®å¼‚"><a href="#5-å®Œæˆäº‹ä»¶å¤„ç†çš„å·®å¼‚" class="headerlink" title="5. å®Œæˆäº‹ä»¶å¤„ç†çš„å·®å¼‚"></a>5. å®Œæˆäº‹ä»¶å¤„ç†çš„å·®å¼‚</h4><h5 id="åŒè¾¹æ“ä½œå®Œæˆå¤„ç†"><a href="#åŒè¾¹æ“ä½œå®Œæˆå¤„ç†" class="headerlink" title="åŒè¾¹æ“ä½œå®Œæˆå¤„ç†"></a>åŒè¾¹æ“ä½œå®Œæˆå¤„ç†</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">handle_two_sided_completion</span><span class="params">(<span class="keyword">struct</span> ibv_wc* wc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (wc-&gt;opcode == IBV_WC_RECV) &#123;</span><br><span class="line">        <span class="comment">// æ¥æ”¶åˆ°æ¶ˆæ¯</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œé•¿åº¦: &quot;</span> &lt;&lt; wc-&gt;byte_len &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// éœ€è¦é‡æ–°å‘å¸ƒRECVè¯·æ±‚</span></span><br><span class="line">        <span class="built_in">post_receive</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wc-&gt;opcode == IBV_WC_SEND) &#123;</span><br><span class="line">        <span class="comment">// å‘é€å®Œæˆ</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;å‘é€æ“ä½œå®Œæˆ&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="å•è¾¹æ“ä½œå®Œæˆå¤„ç†"><a href="#å•è¾¹æ“ä½œå®Œæˆå¤„ç†" class="headerlink" title="å•è¾¹æ“ä½œå®Œæˆå¤„ç†"></a>å•è¾¹æ“ä½œå®Œæˆå¤„ç†</h5><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">handle_one_sided_completion</span><span class="params">(<span class="keyword">struct</span> ibv_wc* wc)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (wc-&gt;opcode == IBV_WC_RDMA_WRITE) &#123;</span><br><span class="line">        <span class="comment">// RDMAå†™å…¥å®Œæˆ</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;RDMAå†™å…¥æ“ä½œå®Œæˆ&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wc-&gt;opcode == IBV_WC_RDMA_READ) &#123;</span><br><span class="line">        <span class="comment">// RDMAè¯»å–å®Œæˆï¼Œæ•°æ®ç°åœ¨åœ¨æœ¬åœ°ç¼“å†²åŒº</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;RDMAè¯»å–æ“ä½œå®Œæˆï¼Œæ•°æ®å·²å°±ç»ª&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šè¿œç¨‹ç«¯ä¸ä¼šæœ‰å®Œæˆäº‹ä»¶ï¼Œå› ä¸ºå…¶CPUæœªå‚ä¸</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="ğŸ¯-é€‰æ‹©æŒ‡å—"><a href="#ğŸ¯-é€‰æ‹©æŒ‡å—" class="headerlink" title="ğŸ¯ é€‰æ‹©æŒ‡å—"></a>ğŸ¯ é€‰æ‹©æŒ‡å—</h3><h4 id="ä½¿ç”¨åŒè¾¹æ“ä½œçš„åœºæ™¯ï¼š"><a href="#ä½¿ç”¨åŒè¾¹æ“ä½œçš„åœºæ™¯ï¼š" class="headerlink" title="ä½¿ç”¨åŒè¾¹æ“ä½œçš„åœºæ™¯ï¼š"></a>ä½¿ç”¨åŒè¾¹æ“ä½œçš„åœºæ™¯ï¼š</h4><ul>
<li><strong>éœ€è¦æ˜ç¡®çš„æ¶ˆæ¯ç¡®è®¤</strong></li>
<li><strong>é€šä¿¡æ¨¡å¼ç±»ä¼¼äºä¼ ç»Ÿç½‘ç»œç¼–ç¨‹</strong></li>
<li><strong>è¿œç¨‹ç«¯éœ€è¦çŸ¥é“æ¯æ¬¡é€šä¿¡çš„å‘ç”Ÿ</strong></li>
<li><strong>å¼€å‘å¤æ‚åº¦è¦æ±‚è¾ƒä½</strong></li>
</ul>
<h4 id="ä½¿ç”¨å•è¾¹æ“ä½œçš„åœºæ™¯ï¼š"><a href="#ä½¿ç”¨å•è¾¹æ“ä½œçš„åœºæ™¯ï¼š" class="headerlink" title="ä½¿ç”¨å•è¾¹æ“ä½œçš„åœºæ™¯ï¼š"></a>ä½¿ç”¨å•è¾¹æ“ä½œçš„åœºæ™¯ï¼š</h4><ul>
<li><strong>å¯¹å»¶è¿Ÿå’ŒCPUå¼€é”€æå…¶æ•æ„Ÿ</strong></li>
<li><strong>éœ€è¦é¢‘ç¹çš„å¤§æ•°æ®é‡ä¼ è¾“</strong></li>
<li><strong>è¿œç¨‹ç«¯ä¸éœ€è¦çŸ¥é“æ¯æ¬¡å†…å­˜è®¿é—®</strong></li>
<li><strong>å¯ä»¥å®ç°æ›´å¤æ‚çš„é€šä¿¡æ¨¡å¼ï¼ˆå¦‚åˆ†å¸ƒå¼å…±äº«å†…å­˜ï¼‰</strong></li>
</ul>
<h3 id="ğŸ’¡-å®é™…å»ºè®®"><a href="#ğŸ’¡-å®é™…å»ºè®®" class="headerlink" title="ğŸ’¡ å®é™…å»ºè®®"></a>ğŸ’¡ å®é™…å»ºè®®</h3><ol>
<li><strong>ä»åŒè¾¹æ“ä½œå¼€å§‹</strong>ï¼šå¦‚æœä½ åˆšå¼€å§‹å­¦ä¹ RDMAï¼Œå»ºè®®å…ˆæŒæ¡åŒè¾¹æ“ä½œ</li>
<li><strong>æ¸è¿›å¼è¿ç§»</strong>ï¼šåœ¨ç†è§£åŒè¾¹æ“ä½œçš„åŸºç¡€ä¸Šï¼Œé€æ­¥è¿‡æ¸¡åˆ°å•è¾¹æ“ä½œ</li>
<li><strong>æ··åˆä½¿ç”¨</strong>ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œç»å¸¸æ··åˆä½¿ç”¨ä¸¤ç§æ¨¡å¼ï¼š<ul>
<li>ä½¿ç”¨åŒè¾¹æ“ä½œäº¤æ¢æ§åˆ¶ä¿¡æ¯å’Œå†…å­˜å…ƒæ•°æ®</li>
<li>ä½¿ç”¨å•è¾¹æ“ä½œè¿›è¡Œé«˜æ•ˆçš„æ•°æ®ä¼ è¾“</li>
</ul>
</li>
</ol>
<p>ç†è§£è¿™äº›å·®å¼‚æœ‰åŠ©äºä½ æ ¹æ®å…·ä½“åº”ç”¨éœ€æ±‚é€‰æ‹©åˆé€‚çš„RDMAæ“ä½œæ¨¡å¼ã€‚</p>
<h2 id="3-åŒè¾¹"><a href="#3-åŒè¾¹" class="headerlink" title="3. åŒè¾¹"></a>3. åŒè¾¹</h2><p>RDMAï¼ˆè¿œç¨‹ç›´æ¥å†…å­˜è®¿é—®ï¼‰æŠ€æœ¯å…è®¸è®¡ç®—æœºç›´æ¥è®¿é—®å¦ä¸€å°è®¡ç®—æœºçš„å†…å­˜ï¼Œè€Œæ— éœ€å¯¹æ–¹å¤„ç†å™¨çš„å‚ä¸ï¼Œä»è€Œæ˜¾è‘—é™ä½é€šä¿¡å»¶è¿Ÿå¹¶æé«˜ååé‡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºäºRDMAçš„SEND&#x2F;RECVæ“ä½œæ¨¡å¼çš„ç®€å•ç¤ºä¾‹ï¼Œå®ƒæ¼”ç¤ºäº†å¦‚ä½•å»ºç«‹è¿æ¥å¹¶è¿›è¡ŒåŸºæœ¬çš„æ•°æ®ä¼ è¾“ã€‚</p>
<h3 id="ğŸ”§-RDMAé€šä¿¡åŸºç¡€ç¤ºä¾‹"><a href="#ğŸ”§-RDMAé€šä¿¡åŸºç¡€ç¤ºä¾‹" class="headerlink" title="ğŸ”§ RDMAé€šä¿¡åŸºç¡€ç¤ºä¾‹"></a>ğŸ”§ RDMAé€šä¿¡åŸºç¡€ç¤ºä¾‹</h3><p>ä»¥ä¸‹C++ä»£ç ç¤ºä¾‹å±•ç¤ºäº†ä½¿ç”¨RDMAè¿›è¡Œæ•°æ®ä¼ è¾“çš„åŸºæœ¬æ¡†æ¶ã€‚è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…åº”ç”¨ä¸­éœ€è¦æ›´å®Œå–„çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†ã€‚</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rdma/rdma_cma.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_MSG_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RDMAè¿æ¥ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RDMAConnectionContext</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_context</span>* context;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_pd</span>* protection_domain;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_cq</span>* completion_queue;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_comp_channel</span>* comp_channel;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp</span>* queue_pair;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* send_mr;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* recv_mr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å†²åŒº</span></span><br><span class="line">    <span class="type">char</span>* send_region;</span><br><span class="line">    <span class="type">char</span>* recv_region;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®Œæˆäº‹ä»¶å¤„ç†çº¿ç¨‹</span></span><br><span class="line">    <span class="type">pthread_t</span> comp_thread;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæˆäº‹ä»¶å¤„ç†çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">completion_thread</span><span class="params">(<span class="type">void</span>* arg)</span> </span>&#123;</span><br><span class="line">    RDMAConnectionContext* ctx = (RDMAConnectionContext*)arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">ibv_cq</span>* cq;</span><br><span class="line">        <span class="type">void</span>* cq_context;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰å¾…å®Œæˆäº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ibv_get_cq_event</span>(ctx-&gt;comp_channel, &amp;cq, &amp;cq_context) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">ibv_ack_cq_events</span>(cq, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">ibv_req_notify_cq</span>(cq, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¤„ç†å·¥ä½œå®Œæˆ</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">ibv_wc</span> wc;</span><br><span class="line">            <span class="type">int</span> comp_count = <span class="built_in">ibv_poll_cq</span>(cq, <span class="number">1</span>, &amp;wc);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (comp_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (wc.status == IBV_WC_SUCCESS) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (wc.opcode &amp; IBV_WC_RECV) &#123;</span><br><span class="line">                        std::cout &lt;&lt; <span class="string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯: &quot;</span> &lt;&lt; ctx-&gt;recv_region &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// é‡æ–°æŠ•é€’æ¥æ”¶è¯·æ±‚</span></span><br><span class="line">                        <span class="keyword">struct</span> <span class="title class_">ibv_recv_wr</span> wr, *bad_wr;</span><br><span class="line">                        <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(wr));</span><br><span class="line">                        wr.wr_id = (<span class="type">uintptr_t</span>)ctx-&gt;recv_region;</span><br><span class="line">                        wr.next = <span class="literal">NULL</span>;</span><br><span class="line">                        wr.sg_list = &amp;sge;</span><br><span class="line">                        wr.num_sge = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                        sge.addr = (<span class="type">uintptr_t</span>)ctx-&gt;recv_region;</span><br><span class="line">                        sge.length = MAX_MSG_SIZE;</span><br><span class="line">                        sge.lkey = ctx-&gt;recv_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">ibv_post_recv</span>(ctx-&gt;queue_pair, &amp;wr, &amp;bad_wr);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wc.opcode == IBV_WC_SEND) &#123;</span><br><span class="line">                        std::cout &lt;&lt; <span class="string">&quot;å‘é€æ“ä½œå®Œæˆ&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–RDMAè¿æ¥ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="function">RDMAConnectionContext* <span class="title">init_rdma_connection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RDMAConnectionContext* ctx = <span class="keyword">new</span> <span class="built_in">RDMAConnectionContext</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–RDMAè®¾å¤‡åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_device</span>** device_list = <span class="built_in">ibv_get_device_list</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!device_list) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æœªæ‰¾åˆ°RDMAè®¾å¤‡&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">delete</span> ctx;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€ç¬¬ä¸€ä¸ªè®¾å¤‡</span></span><br><span class="line">    ctx-&gt;context = <span class="built_in">ibv_open_device</span>(device_list[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!ctx-&gt;context) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æ— æ³•æ‰“å¼€RDMAè®¾å¤‡&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">ibv_free_device_list</span>(device_list);</span><br><span class="line">        <span class="keyword">delete</span> ctx;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¿æŠ¤åŸŸ</span></span><br><span class="line">    ctx-&gt;protection_domain = <span class="built_in">ibv_alloc_pd</span>(ctx-&gt;context);</span><br><span class="line">    <span class="keyword">if</span> (!ctx-&gt;protection_domain) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æ— æ³•åˆ†é…ä¿æŠ¤åŸŸ&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">ibv_close_device</span>(ctx-&gt;context);</span><br><span class="line">        <span class="built_in">ibv_free_device_list</span>(device_list);</span><br><span class="line">        <span class="keyword">delete</span> ctx;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå®Œæˆé˜Ÿåˆ—</span></span><br><span class="line">    ctx-&gt;comp_channel = <span class="built_in">ibv_create_comp_channel</span>(ctx-&gt;context);</span><br><span class="line">    ctx-&gt;completion_queue = <span class="built_in">ibv_create_cq</span>(ctx-&gt;context, <span class="number">10</span>, <span class="literal">NULL</span>, ctx-&gt;comp_channel, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œå†…å­˜åŒºåŸŸ</span></span><br><span class="line">    ctx-&gt;send_region = <span class="keyword">new</span> <span class="type">char</span>[MAX_MSG_SIZE];</span><br><span class="line">    ctx-&gt;recv_region = <span class="keyword">new</span> <span class="type">char</span>[MAX_MSG_SIZE];</span><br><span class="line"></span><br><span class="line">    ctx-&gt;send_mr = <span class="built_in">ibv_reg_mr</span>(ctx-&gt;protection_domain, ctx-&gt;send_region, MAX_MSG_SIZE,</span><br><span class="line">                             IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_READ);</span><br><span class="line">    ctx-&gt;recv_mr = <span class="built_in">ibv_reg_mr</span>(ctx-&gt;protection_domain, ctx-&gt;recv_region, MAX_MSG_SIZE,</span><br><span class="line">                             IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_READ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºé˜Ÿåˆ—å¯¹</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp_init_attr</span> qp_init_attr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;qp_init_attr, <span class="number">0</span>, <span class="built_in">sizeof</span>(qp_init_attr));</span><br><span class="line">    qp_init_attr.send_cq = ctx-&gt;completion_queue;</span><br><span class="line">    qp_init_attr.recv_cq = ctx-&gt;completion_queue;</span><br><span class="line">    qp_init_attr.qp_type = IBV_QPT_RC;</span><br><span class="line"></span><br><span class="line">    qp_init_attr.cap.max_send_wr = <span class="number">10</span>;</span><br><span class="line">    qp_init_attr.cap.max_recv_wr = <span class="number">10</span>;</span><br><span class="line">    qp_init_attr.cap.max_send_sge = <span class="number">1</span>;</span><br><span class="line">    qp_init_attr.cap.max_recv_sge = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;queue_pair = <span class="built_in">ibv_create_qp</span>(ctx-&gt;protection_domain, &amp;qp_init_attr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨å®Œæˆäº‹ä»¶å¤„ç†çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;ctx-&gt;comp_thread, <span class="literal">NULL</span>, completion_thread, ctx);</span><br><span class="line">    <span class="built_in">ibv_req_notify_cq</span>(ctx-&gt;completion_queue, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ibv_free_device_list</span>(device_list);</span><br><span class="line">    <span class="keyword">return</span> ctx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rdma_send_message</span><span class="params">(RDMAConnectionContext* ctx, <span class="type">const</span> <span class="type">char</span>* message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(message) &gt;= MAX_MSG_SIZE) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æ¶ˆæ¯è¿‡é•¿&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤åˆ¶æ¶ˆæ¯åˆ°å‘é€åŒºåŸŸ</span></span><br><span class="line">    <span class="built_in">strcpy</span>(ctx-&gt;send_region, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡å‘é€å·¥ä½œè¯·æ±‚</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_send_wr</span> wr, *bad_wr;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(wr));</span><br><span class="line">    wr.wr_id = (<span class="type">uintptr_t</span>)ctx-&gt;send_region;</span><br><span class="line">    wr.next = <span class="literal">NULL</span>;</span><br><span class="line">    wr.sg_list = &amp;sge;</span><br><span class="line">    wr.num_sge = <span class="number">1</span>;</span><br><span class="line">    wr.opcode = IBV_WR_SEND;</span><br><span class="line">    wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">    sge.addr = (<span class="type">uintptr_t</span>)ctx-&gt;send_region;</span><br><span class="line">    sge.length = <span class="built_in">strlen</span>(message) + <span class="number">1</span>;</span><br><span class="line">    sge.lkey = ctx-&gt;send_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ibv_post_send</span>(ctx-&gt;queue_pair, &amp;wr, &amp;bad_wr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ•é€’æ¥æ”¶è¯·æ±‚</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">post_receive_request</span><span class="params">(RDMAConnectionContext* ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_recv_wr</span> wr, *bad_wr;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(wr));</span><br><span class="line">    wr.wr_id = (<span class="type">uintptr_t</span>)ctx-&gt;recv_region;</span><br><span class="line">    wr.next = <span class="literal">NULL</span>;</span><br><span class="line">    wr.sg_list = &amp;sge;</span><br><span class="line">    wr.num_sge = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    sge.addr = (<span class="type">uintptr_t</span>)ctx-&gt;recv_region;</span><br><span class="line">    sge.length = MAX_MSG_SIZE;</span><br><span class="line">    sge.lkey = ctx-&gt;recv_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ibv_post_recv</span>(ctx-&gt;queue_pair, &amp;wr, &amp;bad_wr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†èµ„æº</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cleanup_rdma_connection</span><span class="params">(RDMAConnectionContext* ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ctx) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_cancel</span>(ctx-&gt;comp_thread);</span><br><span class="line">    <span class="built_in">pthread_join</span>(ctx-&gt;comp_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;queue_pair) <span class="built_in">ibv_destroy_qp</span>(ctx-&gt;queue_pair);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;send_mr) <span class="built_in">ibv_dereg_mr</span>(ctx-&gt;send_mr);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;recv_mr) <span class="built_in">ibv_dereg_mr</span>(ctx-&gt;recv_mr);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;completion_queue) <span class="built_in">ibv_destroy_cq</span>(ctx-&gt;completion_queue);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;comp_channel) <span class="built_in">ibv_destroy_comp_channel</span>(ctx-&gt;comp_channel);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;protection_domain) <span class="built_in">ibv_dealloc_pd</span>(ctx-&gt;protection_domain);</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;context) <span class="built_in">ibv_close_device</span>(ctx-&gt;context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>[] ctx-&gt;send_region;</span><br><span class="line">    <span class="keyword">delete</span>[] ctx-&gt;recv_region;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> ctx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;åˆå§‹åŒ–RDMAè¿æ¥...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    RDMAConnectionContext* ctx = <span class="built_in">init_rdma_connection</span>();</span><br><span class="line">    <span class="keyword">if</span> (!ctx) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;RDMAè¿æ¥åˆå§‹åŒ–å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ•é€’åˆå§‹æ¥æ”¶è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">post_receive_request</span>(ctx) != <span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æ— æ³•æŠ•é€’æ¥æ”¶è¯·æ±‚&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">cleanup_rdma_connection</span>(ctx);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;RDMAè¿æ¥å·²å°±ç»ª&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¼”ç¤ºå‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* test_message = <span class="string">&quot;Hello, RDMA!&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rdma_send_message</span>(ctx, test_message) == <span class="number">0</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ¶ˆæ¯å·²å‘é€: &quot;</span> &lt;&lt; test_message &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;å‘é€æ¶ˆæ¯å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸€æ®µæ—¶é—´ä»¥æ¥æ”¶å¯èƒ½çš„å›å¤</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cleanup_rdma_connection</span>(ctx);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;RDMAè¿æ¥å·²å…³é—­&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="ğŸ’»-ç¼–è¯‘ä¸è¿è¡Œ"><a href="#ğŸ’»-ç¼–è¯‘ä¸è¿è¡Œ" class="headerlink" title="ğŸ’» ç¼–è¯‘ä¸è¿è¡Œ"></a>ğŸ’» ç¼–è¯‘ä¸è¿è¡Œ</h3><p>è¦ç¼–è¯‘æ­¤ä»£ç ï¼Œä½ éœ€è¦å®‰è£…RDMAå¼€å‘åº“ï¼ˆåœ¨Ubuntuä¸Šé€šå¸¸æ˜¯<code>librdmacm-dev</code>å’Œ<code>libibverbs-dev</code>åŒ…ï¼‰ã€‚ç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -std=c++11 -o rdma_demo rdma_demo.cpp -lrdmacm -libverbs -lpthread</span><br></pre></td></tr></table></figure></div>

<h3 id="ğŸ”-ä»£ç å…³é”®ç‚¹è¯´æ˜"><a href="#ğŸ”-ä»£ç å…³é”®ç‚¹è¯´æ˜" class="headerlink" title="ğŸ” ä»£ç å…³é”®ç‚¹è¯´æ˜"></a>ğŸ” ä»£ç å…³é”®ç‚¹è¯´æ˜</h3><ol>
<li><p><strong>RDMAæ“ä½œæ¨¡å¼</strong>ï¼šæ­¤ä»£ç ä½¿ç”¨äº†<strong>SEND&#x2F;RECV</strong>æ“ä½œæ¨¡å¼ï¼Œè¿™æ˜¯RDMAçš„ä¸€ç§åŸºæœ¬é€šä¿¡æ–¹å¼ï¼Œè¦æ±‚å‘é€å’Œæ¥æ”¶ç«¯éƒ½æ˜ç¡®å‚ä¸ã€‚</p>
</li>
<li><p><strong>æ ¸å¿ƒç»„ä»¶</strong>ï¼š</p>
<ul>
<li><strong>ä¿æŠ¤åŸŸï¼ˆProtection Domainï¼‰</strong>ï¼šéš”ç¦»RDMAèµ„æº</li>
<li><strong>å®Œæˆé˜Ÿåˆ—ï¼ˆCompletion Queueï¼‰</strong>ï¼šè®°å½•å·²å®Œæˆçš„æ“ä½œ</li>
<li><strong>é˜Ÿåˆ—å¯¹ï¼ˆQueue Pairï¼‰</strong>ï¼šåŒ…å«å‘é€å’Œæ¥æ”¶é˜Ÿåˆ—</li>
<li><strong>å†…å­˜åŒºåŸŸï¼ˆMemory Regionï¼‰</strong>ï¼šæ³¨å†Œç”¨äºRDMAæ“ä½œçš„å†…å­˜</li>
</ul>
</li>
<li><p><strong>æ•°æ®ä¼ è¾“</strong>ï¼šé€šè¿‡<code>ibv_post_send</code>å’Œ<code>ibv_post_recv</code>å‡½æ•°æäº¤å‘é€å’Œæ¥æ”¶è¯·æ±‚ï¼Œç”±ç¡¬ä»¶å¼‚æ­¥å¤„ç†ã€‚</p>
</li>
</ol>
<h3 id="ğŸ› -å®é™…åº”ç”¨è€ƒè™‘"><a href="#ğŸ› -å®é™…åº”ç”¨è€ƒè™‘" class="headerlink" title="ğŸ›  å®é™…åº”ç”¨è€ƒè™‘"></a>ğŸ›  å®é™…åº”ç”¨è€ƒè™‘</h3><p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ï¼š</p>
<ul>
<li>å®ç°<strong>é˜Ÿåˆ—å¯¹çŠ¶æ€æœº</strong>ç®¡ç†ï¼ˆä»RESETåˆ°INITã€RTRã€RTSçŠ¶æ€ï¼‰</li>
<li>æ·»åŠ <strong>æ›´å®Œå–„çš„é”™è¯¯å¤„ç†</strong>å’Œè¶…æ—¶æœºåˆ¶</li>
<li>å®ç°<strong>è¿æ¥ç®¡ç†</strong>ï¼ˆä½¿ç”¨rdma_cma APIï¼‰</li>
<li>è€ƒè™‘ä½¿ç”¨<strong>RDMA READ&#x2F;WRITEæ“ä½œ</strong>ä»¥å®ç°å•è¾¹é€šä¿¡</li>
<li>å®æ–½<strong>å†…å­˜å›ºå®š</strong>æŠ€æœ¯ä»¥æé«˜æ€§èƒ½</li>
</ul>
<h2 id="4-å•è¾¹"><a href="#4-å•è¾¹" class="headerlink" title="4. å•è¾¹"></a>4. å•è¾¹</h2><p>RDMAå•è¾¹æ“ä½œï¼ˆOne-Sided Operationsï¼‰åŒ…æ‹¬RDMA Writeã€RDMA Readå’ŒåŸå­æ“ä½œï¼Œè¿™äº›æ“ä½œä¸éœ€è¦è¿œç¨‹ç«¯çš„CPUå‚ä¸ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨RDMA Writeçš„å•è¾¹é€šä¿¡ç¤ºä¾‹ï¼š</p>
<h3 id="ğŸ”§-RDMAå•è¾¹å†™å…¥ç¤ºä¾‹"><a href="#ğŸ”§-RDMAå•è¾¹å†™å…¥ç¤ºä¾‹" class="headerlink" title="ğŸ”§ RDMAå•è¾¹å†™å…¥ç¤ºä¾‹"></a>ğŸ”§ RDMAå•è¾¹å†™å…¥ç¤ºä¾‹</h3><div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rdma/rdma_cma.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;rdma/rdma_verbs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT <span class="string">&quot;12345&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RDMAè¿æ¥ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RDMAContext</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_context</span>* ctx;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_pd</span>* pd;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_cq</span>* cq;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp</span>* qp;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* mr;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* buffer;</span><br><span class="line">    <span class="type">uint32_t</span> rkey;</span><br><span class="line">    <span class="type">uint64_t</span> remote_addr;</span><br><span class="line">    <span class="type">uint32_t</span> remote_rkey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_event_channel</span>* ec;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_cm_id</span>* id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å­˜åŒºåŸŸä¿¡æ¯äº¤æ¢ç»“æ„</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MemoryInfo</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> addr;</span><br><span class="line">    <span class="type">uint32_t</span> rkey;</span><br><span class="line">    <span class="type">uint32_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæˆäº‹ä»¶å¤„ç†</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">poll_completion</span><span class="params">(RDMAContext* ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_wc</span> wc;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ret = <span class="built_in">ibv_poll_cq</span>(ctx-&gt;cq, <span class="number">1</span>, &amp;wc);</span><br><span class="line">    &#125; <span class="keyword">while</span> (ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è½®è¯¢å®Œæˆé˜Ÿåˆ—å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wc.status != IBV_WC_SUCCESS) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;å·¥ä½œè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€: &quot;</span> &lt;&lt; wc.status &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»ºç«‹QPåˆ°RTSçŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">setup_qp</span><span class="params">(RDMAContext* ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp_attr</span> attr;</span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç½®åˆ°INITçŠ¶æ€</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;attr, <span class="number">0</span>, <span class="built_in">sizeof</span>(attr));</span><br><span class="line">    attr.qp_state = IBV_QPS_INIT;</span><br><span class="line">    attr.port_num = <span class="number">1</span>;</span><br><span class="line">    attr.pkey_index = <span class="number">0</span>;</span><br><span class="line">    attr.qp_access_flags = IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_READ | </span><br><span class="line">                          IBV_ACCESS_REMOTE_WRITE;</span><br><span class="line"></span><br><span class="line">    flags = IBV_QP_STATE | IBV_QP_PKEY_INDEX | IBV_QP_PORT | IBV_QP_ACCESS_FLAGS;</span><br><span class="line">    ret = <span class="built_in">ibv_modify_qp</span>(ctx-&gt;qp, &amp;attr, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;ä¿®æ”¹QPåˆ°INITçŠ¶æ€å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢åˆ°RTRçŠ¶æ€</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;attr, <span class="number">0</span>, <span class="built_in">sizeof</span>(attr));</span><br><span class="line">    attr.qp_state = IBV_QPS_RTR;</span><br><span class="line">    attr.path_mtu = IBV_MTU_1024;</span><br><span class="line">    attr.dest_qp_num = ctx-&gt;qp-&gt;qp_num;</span><br><span class="line">    attr.rq_psn = <span class="number">0</span>;</span><br><span class="line">    attr.max_dest_rd_atomic = <span class="number">1</span>;</span><br><span class="line">    attr.min_rnr_timer = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">    attr.ah_attr.is_global = <span class="number">0</span>;</span><br><span class="line">    attr.ah_attr.dlid = <span class="number">1</span>;  <span class="comment">// åœ¨å®é™…ç³»ç»Ÿä¸­éœ€è¦æ­£ç¡®è®¾ç½®</span></span><br><span class="line">    attr.ah_attr.sl = <span class="number">0</span>;</span><br><span class="line">    attr.ah_attr.src_path_bits = <span class="number">0</span>;</span><br><span class="line">    attr.ah_attr.port_num = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    flags = IBV_QP_STATE | IBV_QP_AV | IBV_QP_PATH_MTU | IBV_QP_DEST_QPN |</span><br><span class="line">            IBV_QP_RQ_PSN | IBV_QP_MAX_DEST_RD_ATOMIC | IBV_QP_MIN_RNR_TIMER;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">ibv_modify_qp</span>(ctx-&gt;qp, &amp;attr, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;ä¿®æ”¹QPåˆ°RTRçŠ¶æ€å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æ¢åˆ°RTSçŠ¶æ€</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;attr, <span class="number">0</span>, <span class="built_in">sizeof</span>(attr));</span><br><span class="line">    attr.qp_state = IBV_QPS_RTS;</span><br><span class="line">    attr.timeout = <span class="number">14</span>;</span><br><span class="line">    attr.retry_cnt = <span class="number">7</span>;</span><br><span class="line">    attr.rnr_retry = <span class="number">7</span>;</span><br><span class="line">    attr.sq_psn = <span class="number">0</span>;</span><br><span class="line">    attr.max_rd_atomic = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    flags = IBV_QP_STATE | IBV_QP_TIMEOUT | IBV_QP_RETRY_CNT |</span><br><span class="line">            IBV_QP_RNR_RETRY | IBV_QP_SQ_PSN | IBV_QP_MAX_QP_RD_ATOMIC;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">ibv_modify_qp</span>(ctx-&gt;qp, &amp;attr, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;ä¿®æ”¹QPåˆ°RTSçŠ¶æ€å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯ä»£ç </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run_server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RDMAContext ctx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_addrinfo</span>* res = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_addrinfo</span> hints;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å¯åŠ¨RDMAæœåŠ¡å™¨...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº‹ä»¶é€šé“</span></span><br><span class="line">    ctx.ec = <span class="built_in">rdma_create_event_channel</span>();</span><br><span class="line">    <span class="keyword">if</span> (!ctx.ec) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åˆ›å»ºäº‹ä»¶é€šé“å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºCM ID</span></span><br><span class="line">    ret = <span class="built_in">rdma_create_id</span>(ctx.ec, &amp;ctx.id, <span class="literal">NULL</span>, RDMA_PS_TCP);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åˆ›å»ºCM IDå¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æåœ°å€</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="built_in">sizeof</span>(hints));</span><br><span class="line">    hints.ai_port_space = RDMA_PS_TCP;</span><br><span class="line">    ret = <span class="built_in">rdma_getaddrinfo</span>(<span class="literal">NULL</span>, PORT, &amp;hints, &amp;res);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–åœ°å€ä¿¡æ¯å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šåœ°å€å¹¶ç›‘å¬</span></span><br><span class="line">    ret = <span class="built_in">rdma_bind_addr</span>(ctx.id, res-&gt;ai_src_addr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;ç»‘å®šåœ°å€å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">rdma_listen</span>(ctx.id, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;ç›‘å¬å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æœåŠ¡å™¨ç›‘å¬åœ¨ç«¯å£ &quot;</span> &lt;&lt; PORT &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…è¿æ¥</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_cm_event</span>* event;</span><br><span class="line">    ret = <span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;event);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–CMäº‹ä»¶å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (event-&gt;event != RDMA_CM_EVENT_CONNECT_REQUEST) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æ„å¤–äº‹ä»¶: &quot;</span> &lt;&lt; event-&gt;event &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥å—è¿æ¥è¯·æ±‚</span></span><br><span class="line">    ctx.id = event-&gt;id;</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»ºç«‹QPç­‰èµ„æº</span></span><br><span class="line">    ctx.ctx = ctx.id-&gt;verbs;</span><br><span class="line">    ctx.pd = <span class="built_in">ibv_alloc_pd</span>(ctx.ctx);</span><br><span class="line">    ctx.cq = <span class="built_in">ibv_create_cq</span>(ctx.ctx, <span class="number">10</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp_init_attr</span> qp_attr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;qp_attr, <span class="number">0</span>, <span class="built_in">sizeof</span>(qp_attr));</span><br><span class="line">    qp_attr.cap.max_send_wr = <span class="number">10</span>;</span><br><span class="line">    qp_attr.cap.max_recv_wr = <span class="number">10</span>;</span><br><span class="line">    qp_attr.cap.max_send_sge = <span class="number">1</span>;</span><br><span class="line">    qp_attr.cap.max_recv_sge = <span class="number">1</span>;</span><br><span class="line">    qp_attr.send_cq = ctx.cq;</span><br><span class="line">    qp_attr.recv_cq = ctx.cq;</span><br><span class="line">    qp_attr.qp_type = IBV_QPT_RC;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">rdma_create_qp</span>(ctx.id, ctx.pd, &amp;qp_attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åˆ›å»ºQPå¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.qp = ctx.id-&gt;qp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œå†…å­˜åŒºåŸŸ</span></span><br><span class="line">    ctx.buffer = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line">    ctx.mr = <span class="built_in">ibv_reg_mr</span>(ctx.pd, ctx.buffer, BUFFER_SIZE, </span><br><span class="line">                       IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_WRITE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡è¿æ¥ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_conn_param</span> cm_params;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;cm_params, <span class="number">0</span>, <span class="built_in">sizeof</span>(cm_params));</span><br><span class="line">    cm_params.responder_resources = <span class="number">1</span>;</span><br><span class="line">    cm_params.initiator_depth = <span class="number">1</span>;</span><br><span class="line">    cm_params.rnr_retry_count = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥å—è¿æ¥</span></span><br><span class="line">    ret = <span class="built_in">rdma_accept</span>(ctx.id, &amp;cm_params);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æ¥å—è¿æ¥å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…è¿æ¥å»ºç«‹</span></span><br><span class="line">    ret = <span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;event);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–CMäº‹ä»¶å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (event-&gt;event != RDMA_CM_EVENT_ESTABLISHED) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è¿æ¥å»ºç«‹å¤±è´¥ï¼Œäº‹ä»¶: &quot;</span> &lt;&lt; event-&gt;event &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;RDMAè¿æ¥å·²å»ºç«‹&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…å®¢æˆ·ç«¯å†™å…¥æ•°æ®</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;ç­‰å¾…å®¢æˆ·ç«¯å†™å…¥æ•°æ®...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ•°æ®: &quot;</span> &lt;&lt; ctx.buffer &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (res) <span class="built_in">rdma_freeaddrinfo</span>(res);</span><br><span class="line">    <span class="keyword">if</span> (ctx.mr) <span class="built_in">ibv_dereg_mr</span>(ctx.mr);</span><br><span class="line">    <span class="keyword">if</span> (ctx.buffer) <span class="keyword">delete</span>[] ctx.buffer;</span><br><span class="line">    <span class="keyword">if</span> (ctx.qp) <span class="built_in">rdma_destroy_qp</span>(ctx.id);</span><br><span class="line">    <span class="keyword">if</span> (ctx.cq) <span class="built_in">ibv_destroy_cq</span>(ctx.cq);</span><br><span class="line">    <span class="keyword">if</span> (ctx.pd) <span class="built_in">ibv_dealloc_pd</span>(ctx.pd);</span><br><span class="line">    <span class="keyword">if</span> (ctx.id) <span class="built_in">rdma_destroy_id</span>(ctx.id);</span><br><span class="line">    <span class="keyword">if</span> (ctx.ec) <span class="built_in">rdma_destroy_event_channel</span>(ctx.ec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯ä»£ç </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run_client</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RDMAContext ctx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_addrinfo</span>* res = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_addrinfo</span> hints;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;å¯åŠ¨RDMAå®¢æˆ·ç«¯...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº‹ä»¶é€šé“</span></span><br><span class="line">    ctx.ec = <span class="built_in">rdma_create_event_channel</span>();</span><br><span class="line">    <span class="keyword">if</span> (!ctx.ec) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åˆ›å»ºäº‹ä»¶é€šé“å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºCM ID</span></span><br><span class="line">    ret = <span class="built_in">rdma_create_id</span>(ctx.ec, &amp;ctx.id, <span class="literal">NULL</span>, RDMA_PS_TCP);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åˆ›å»ºCM IDå¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ææœåŠ¡å™¨åœ°å€</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="built_in">sizeof</span>(hints));</span><br><span class="line">    hints.ai_port_space = RDMA_PS_TCP;</span><br><span class="line">    ret = <span class="built_in">rdma_getaddrinfo</span>(<span class="string">&quot;localhost&quot;</span>, PORT, &amp;hints, &amp;res);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–åœ°å€ä¿¡æ¯å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»ºç«‹QPç­‰èµ„æº</span></span><br><span class="line">    ctx.ctx = ctx.id-&gt;verbs;</span><br><span class="line">    ctx.pd = <span class="built_in">ibv_alloc_pd</span>(ctx.ctx);</span><br><span class="line">    ctx.cq = <span class="built_in">ibv_create_cq</span>(ctx.ctx, <span class="number">10</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_qp_init_attr</span> qp_attr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;qp_attr, <span class="number">0</span>, <span class="built_in">sizeof</span>(qp_attr));</span><br><span class="line">    qp_attr.cap.max_send_wr = <span class="number">10</span>;</span><br><span class="line">    qp_attr.cap.max_recv_wr = <span class="number">10</span>;</span><br><span class="line">    qp_attr.cap.max_send_sge = <span class="number">1</span>;</span><br><span class="line">    qp_attr.cap.max_recv_sge = <span class="number">1</span>;</span><br><span class="line">    qp_attr.send_cq = ctx.cq;</span><br><span class="line">    qp_attr.recv_cq = ctx.cq;</span><br><span class="line">    qp_attr.qp_type = IBV_QPT_RC;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">rdma_create_qp</span>(ctx.id, ctx.pd, &amp;qp_attr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åˆ›å»ºQPå¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.qp = ctx.id-&gt;qp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè·¯ç”±</span></span><br><span class="line">    ret = <span class="built_in">rdma_resolve_addr</span>(ctx.id, <span class="literal">NULL</span>, res-&gt;ai_dst_addr, <span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è§£æåœ°å€å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…åœ°å€è§£æå®Œæˆ</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_cm_event</span>* event;</span><br><span class="line">    ret = <span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;event);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–CMäº‹ä»¶å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (event-&gt;event != RDMA_CM_EVENT_ADDR_RESOLVED) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;åœ°å€è§£æå¤±è´¥ï¼Œäº‹ä»¶: &quot;</span> &lt;&lt; event-&gt;event &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè·¯ç”±</span></span><br><span class="line">    ret = <span class="built_in">rdma_resolve_route</span>(ctx.id, <span class="number">2000</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è§£æè·¯ç”±å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;event);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–CMäº‹ä»¶å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (event-&gt;event != RDMA_CM_EVENT_ROUTE_RESOLVED) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·¯ç”±è§£æå¤±è´¥ï¼Œäº‹ä»¶: &quot;</span> &lt;&lt; event-&gt;event &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å»ºç«‹QPçŠ¶æ€</span></span><br><span class="line">    ret = <span class="built_in">setup_qp</span>(&amp;ctx);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è®¾ç½®QPå¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡è¿æ¥ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_conn_param</span> cm_params;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;cm_params, <span class="number">0</span>, <span class="built_in">sizeof</span>(cm_params));</span><br><span class="line">    cm_params.responder_resources = <span class="number">1</span>;</span><br><span class="line">    cm_params.initiator_depth = <span class="number">1</span>;</span><br><span class="line">    cm_params.rnr_retry_count = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">    ret = <span class="built_in">rdma_connect</span>(ctx.id, &amp;cm_params);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è¿æ¥æœåŠ¡å™¨å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…è¿æ¥å»ºç«‹</span></span><br><span class="line">    ret = <span class="built_in">rdma_get_cm_event</span>(ctx.ec, &amp;event);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è·å–CMäº‹ä»¶å¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (event-&gt;event != RDMA_CM_EVENT_ESTABLISHED) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;è¿æ¥å»ºç«‹å¤±è´¥ï¼Œäº‹ä»¶: &quot;</span> &lt;&lt; event-&gt;event &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">rdma_ack_cm_event</span>(event);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;RDMAè¿æ¥å·²å»ºç«‹&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™é‡Œéœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼äº¤æ¢å†…å­˜ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">// ä¸ºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘ä»¬å‡è®¾å·²ç»çŸ¥é“è¿œç¨‹å†…å­˜ä¿¡æ¯</span></span><br><span class="line">    ctx.remote_addr = <span class="number">0</span>;  <span class="comment">// å®é™…åº”ä»æœåŠ¡å™¨è·å–</span></span><br><span class="line">    ctx.remote_rkey = <span class="number">0</span>;  <span class="comment">// å®é™…åº”ä»æœåŠ¡å™¨è·å–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‡†å¤‡è¦å†™å…¥çš„æ•°æ®</span></span><br><span class="line">    <span class="type">char</span>* local_buffer = <span class="keyword">new</span> <span class="type">char</span>[BUFFER_SIZE];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* message = <span class="string">&quot;Hello from RDMA Write!&quot;</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(local_buffer, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œæœ¬åœ°å†…å­˜ï¼ˆç”¨äºRDMAæ“ä½œï¼‰</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_mr</span>* local_mr = <span class="built_in">ibv_reg_mr</span>(ctx.pd, local_buffer, BUFFER_SIZE, </span><br><span class="line">                                        IBV_ACCESS_LOCAL_WRITE);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;æ‰§è¡ŒRDMA Writeæ“ä½œ...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡ŒRDMA Writeæ“ä½œ</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_send_wr</span> wr, *bad_wr;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ibv_sge</span> sge;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in">sizeof</span>(wr));</span><br><span class="line">    wr.wr_id = <span class="number">1</span>;</span><br><span class="line">    wr.next = <span class="literal">NULL</span>;</span><br><span class="line">    wr.sg_list = &amp;sge;</span><br><span class="line">    wr.num_sge = <span class="number">1</span>;</span><br><span class="line">    wr.opcode = IBV_WR_RDMA_WRITE;</span><br><span class="line">    wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¿œç¨‹å†…å­˜ä¿¡æ¯ï¼ˆåœ¨å®é™…ç³»ç»Ÿä¸­ä»æœåŠ¡å™¨è·å–ï¼‰</span></span><br><span class="line">    wr.wr.rdma.remote_addr = ctx.remote_addr;</span><br><span class="line">    wr.wr.rdma.rkey = ctx.remote_rkey;</span><br><span class="line"></span><br><span class="line">    sge.addr = (<span class="type">uintptr_t</span>)local_buffer;</span><br><span class="line">    sge.length = <span class="built_in">strlen</span>(message) + <span class="number">1</span>;</span><br><span class="line">    sge.lkey = local_mr-&gt;lkey;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">ibv_post_send</span>(ctx.qp, &amp;wr, &amp;bad_wr);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;æäº¤RDMA Writeå¤±è´¥&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ“ä½œå®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">poll_completion</span>(&amp;ctx) == <span class="number">0</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;RDMA Writeæ“ä½œå®Œæˆ&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…ç†æœ¬åœ°å†…å­˜</span></span><br><span class="line">    <span class="keyword">if</span> (local_mr) <span class="built_in">ibv_dereg_mr</span>(local_mr);</span><br><span class="line">    <span class="keyword">delete</span>[] local_buffer;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    <span class="keyword">if</span> (res) <span class="built_in">rdma_freeaddrinfo</span>(res);</span><br><span class="line">    <span class="keyword">if</span> (ctx.qp) <span class="built_in">rdma_destroy_qp</span>(ctx.id);</span><br><span class="line">    <span class="keyword">if</span> (ctx.cq) <span class="built_in">ibv_destroy_cq</span>(ctx.cq);</span><br><span class="line">    <span class="keyword">if</span> (ctx.pd) <span class="built_in">ibv_dealloc_pd</span>(ctx.pd);</span><br><span class="line">    <span class="keyword">if</span> (ctx.id) <span class="built_in">rdma_destroy_id</span>(ctx.id);</span><br><span class="line">    <span class="keyword">if</span> (ctx.ec) <span class="built_in">rdma_destroy_event_channel</span>(ctx.ec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ç”¨æ³•: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; [server|client]&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;server&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">run_server</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;client&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">run_client</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;æ— æ•ˆå‚æ•°ã€‚ç”¨æ³•: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; [server|client]&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="ğŸ”-RDMAå•è¾¹æ“ä½œå…³é”®ç‰¹ç‚¹"><a href="#ğŸ”-RDMAå•è¾¹æ“ä½œå…³é”®ç‰¹ç‚¹" class="headerlink" title="ğŸ” RDMAå•è¾¹æ“ä½œå…³é”®ç‰¹ç‚¹"></a>ğŸ” RDMAå•è¾¹æ“ä½œå…³é”®ç‰¹ç‚¹</h3><h4 id="ğŸ“‹-RDMAå•è¾¹æ“ä½œç±»å‹"><a href="#ğŸ“‹-RDMAå•è¾¹æ“ä½œç±»å‹" class="headerlink" title="ğŸ“‹ RDMAå•è¾¹æ“ä½œç±»å‹"></a>ğŸ“‹ RDMAå•è¾¹æ“ä½œç±»å‹</h4><ol>
<li><strong>RDMA Write</strong> - å°†æ•°æ®ä»æœ¬åœ°å†…å­˜å†™å…¥è¿œç¨‹å†…å­˜</li>
<li><strong>RDMA Read</strong> - ä»è¿œç¨‹å†…å­˜è¯»å–æ•°æ®åˆ°æœ¬åœ°å†…å­˜</li>
<li><strong>åŸå­æ“ä½œ</strong> - åœ¨è¿œç¨‹å†…å­˜ä¸Šæ‰§è¡ŒåŸå­æ“ä½œï¼ˆæ¯”è¾ƒäº¤æ¢ã€è·å–æ·»åŠ ç­‰ï¼‰</li>
</ol>
<h4 id="ğŸ¯-å•è¾¹æ“ä½œçš„ä¼˜åŠ¿"><a href="#ğŸ¯-å•è¾¹æ“ä½œçš„ä¼˜åŠ¿" class="headerlink" title="ğŸ¯ å•è¾¹æ“ä½œçš„ä¼˜åŠ¿"></a>ğŸ¯ å•è¾¹æ“ä½œçš„ä¼˜åŠ¿</h4><ul>
<li><strong>é›¶CPUå‚ä¸</strong>ï¼šè¿œç¨‹ç«¯CPUå®Œå…¨ä¸éœ€è¦çŸ¥é“æˆ–å¤„ç†æ“ä½œ</li>
<li><strong>ä½å»¶è¿Ÿ</strong>ï¼šç»•è¿‡è¿œç¨‹ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸</li>
<li><strong>é«˜ååé‡</strong>ï¼šç›´æ¥å†…å­˜è®¿é—®ï¼Œæ— æ•°æ®æ‹·è´</li>
</ul>
<h4 id="ğŸ”„-å†…å­˜ä¿¡æ¯äº¤æ¢"><a href="#ğŸ”„-å†…å­˜ä¿¡æ¯äº¤æ¢" class="headerlink" title="ğŸ”„ å†…å­˜ä¿¡æ¯äº¤æ¢"></a>ğŸ”„ å†…å­˜ä¿¡æ¯äº¤æ¢</h4><p>å•è¾¹æ“ä½œçš„å…³é”®æŒ‘æˆ˜æ˜¯å¦‚ä½•å®‰å…¨åœ°äº¤æ¢å†…å­˜ä¿¡æ¯ï¼š</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…å­˜ä¿¡æ¯äº¤æ¢ç»“æ„</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MemoryMetadata</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> address;    <span class="comment">// å†…å­˜è™šæ‹Ÿåœ°å€</span></span><br><span class="line">    <span class="type">uint32_t</span> rkey;       <span class="comment">// è¿œç¨‹é”®</span></span><br><span class="line">    <span class="type">uint32_t</span> length;     <span class="comment">// å†…å­˜åŒºåŸŸé•¿åº¦</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº¤æ¢æ–¹å¼ï¼š</span></span><br><span class="line"><span class="comment">// 1. ä½¿ç”¨ä¼ ç»Ÿçš„SEND/RECVæ“ä½œ</span></span><br><span class="line"><span class="comment">// 2. ä½¿ç”¨å¸¦å†…æ•°æ®ï¼ˆinline dataï¼‰</span></span><br><span class="line"><span class="comment">// 3. ä½¿ç”¨å¤–éƒ¨åè°ƒæœºåˆ¶ï¼ˆå¦‚å…±äº«æ–‡ä»¶ã€æ•°æ®åº“ç­‰ï¼‰</span></span><br></pre></td></tr></table></figure></div>

<h3 id="ğŸ› -ç¼–è¯‘ä¸è¿è¡Œ"><a href="#ğŸ› -ç¼–è¯‘ä¸è¿è¡Œ" class="headerlink" title="ğŸ›  ç¼–è¯‘ä¸è¿è¡Œ"></a>ğŸ›  ç¼–è¯‘ä¸è¿è¡Œ</h3><p>ç¼–è¯‘æ­¤ä»£ç éœ€è¦RDMAå¼€å‘åº“ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">sudo apt-get install librdmacm-dev libibverbs-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS/RHEL</span></span><br><span class="line">sudo yum install rdma-core-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line">g++ -std=c++11 -o rdma_one_sided rdma_one_sided.cpp -lrdmacm -libverbs</span><br></pre></td></tr></table></figure></div>

<p>è¿è¡Œç¤ºä¾‹ï¼š</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»ˆç«¯1 - å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">./rdma_one_sided server</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»ˆç«¯2 - å¯åŠ¨å®¢æˆ·ç«¯</span></span><br><span class="line">./rdma_one_sided client</span><br></pre></td></tr></table></figure></div>

<h3 id="ğŸ’¡-å®é™…åº”ç”¨è€ƒè™‘"><a href="#ğŸ’¡-å®é™…åº”ç”¨è€ƒè™‘" class="headerlink" title="ğŸ’¡ å®é™…åº”ç”¨è€ƒè™‘"></a>ğŸ’¡ å®é™…åº”ç”¨è€ƒè™‘</h3><p>åœ¨å®é™…RDMAå•è¾¹é€šä¿¡åº”ç”¨ä¸­ï¼Œéœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li><strong>å†…å­˜æ³¨å†Œ</strong>ï¼šç¡®ä¿å†…å­˜æ˜¯å›ºå®šçš„ä¸”å·²æ­£ç¡®æ³¨å†Œ</li>
<li><strong>å†…å­˜ä¿æŠ¤</strong>ï¼šä½¿ç”¨é€‚å½“çš„è®¿é—®æƒé™æ ‡å¿—</li>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå®ç°å®Œå–„çš„é”™è¯¯æ£€æµ‹å’Œæ¢å¤æœºåˆ¶</li>
<li><strong>å¹¶å‘æ§åˆ¶</strong>ï¼šå¤„ç†å¤šä¸ªå¹¶å‘çš„å•è¾¹æ“ä½œ</li>
<li><strong>å†…å­˜ä¿¡æ¯äº¤æ¢</strong>ï¼šå®‰å…¨åœ°äº¤æ¢å†…å­˜åœ°å€å’Œrkey</li>
</ol>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/553140760" >(22 å°ç§ä¿¡ &#x2F; 80 æ¡æ¶ˆæ¯) ä½¿ç”¨ C++ 20 åç¨‹å°è£… RDMA æ“ä½œ - çŸ¥ä¹ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44727517/article/details/146471038" >æ·±å…¥è§£æRDMAï¼šä»åŸç†åˆ°C++å®è·µ_rdma c++-CSDNåšå®¢ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/wq897387/article/details/131870527" >ä½¿ç”¨Soft-RoCEå®è·µRDMA_softroce-CSDNåšå®¢ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/zzh-wisdom/RDMA-Programming/blob/master/docs/%E7%BC%96%E7%A8%8B%E6%B5%81%E7%A8%8B.md" >RDMA-Programming&#x2F;docs&#x2F;ç¼–ç¨‹æµç¨‹.md at master Â· zzh-wisdom&#x2F;RDMA-Programming <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://cuterwrite.top/p/soft-roce/" >RDMAï¼šSoft-RoCE ç¯å¢ƒæ­å»ºå®éªŒ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/361740115" >(22 å°ç§ä¿¡ &#x2F; 80 æ¡æ¶ˆæ¯) 15. RDMAä¹‹RoCE &amp; Soft-RoCE - çŸ¥ä¹ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://gitee.com/wq897/RDMA-EXAMPLE/blob/master/01/service.c" >01&#x2F;service.c Â· wq&#x2F;RDMA-EXAMPLE - ç äº‘ - å¼€æºä¸­å›½ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42952928/article/details/118295861" >RDMA+UCX_openucx-CSDNåšå®¢ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/madsys-dev/async-ucx/blob/main/.github/workflows/main.yml" >async-ucx&#x2F;.github&#x2F;workflows&#x2F;main.yml at main Â· madsys-dev&#x2F;async-ucx <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.magicdian.cn/202404/%E4%B8%90%E7%89%88RDMA%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%EF%BC%88SoftRoCE%EF%BC%89/" >ä¸ç‰ˆRDMAç¯å¢ƒæ­å»ºï¼ˆSoftRoCEï¼‰ | é­”è¶£å…¸è—é˜ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/SoftRoCE/rxe-dev/issues/57" >No rdma_rxe Â· Issue #57 Â· SoftRoCE&#x2F;rxe-dev <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://rustwiki.org/zh-CN/cargo/commands/cargo-build.html" >cargo build - Cargo æ‰‹å†Œ ä¸­æ–‡ç‰ˆ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/openucx/ucx/tree/master" >openucx&#x2F;ucx: Unified Communication X (mailing list - https://elist.ornl.gov/mailman/listinfo/ucx-group) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/madsys-dev/async-ucx/blob/main/examples/rma.rs" >async-ucx&#x2F;examples&#x2F;rma.rs at main Â· madsys-dev&#x2F;async-ucx <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/397199431" >(25 å°ç§ä¿¡ &#x2F; 80 æ¡æ¶ˆæ¯) async Rust å°è£… UCX é€šä¿¡åº“ - çŸ¥ä¹ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> RDMA learning</li>
        <li><strong>Author:</strong> Ethereal</li>
        <li><strong>Created at:</strong> 2025-08-06 13:06:09</li>
        
            <li>
                <strong>Updated at:</strong> 2025-11-16 20:24:01
            </li>
        
        <li>
            <strong>Link:</strong> https://ethereal-o.github.io/2025/08/06/RDMA-learning/
        </li>
        <li>
            <strong>License:</strong> This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>.
        </li>
    </ul>
</div>

                </div>
            

            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2025/08/15/C-%E7%89%B9%E6%80%A7/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">C++ç‰¹æ€§</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2025/07/23/Minimizing-Congestion-in-Demand-Aware-Reading/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">Minimizing Congestion in Demand-Aware Reading</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-pjax>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://example.example.com',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">RDMA learning</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83"><span class="nav-text">1. å®‰è£…ç¯å¢ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%8D%95%E8%BE%B9%E4%B8%8E%E5%8F%8C%E8%BE%B9"><span class="nav-text">2. å•è¾¹ä¸åŒè¾¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%93%8A-%E6%A0%B8%E5%BF%83%E5%B7%AE%E5%BC%82%E5%AF%B9%E6%AF%94"><span class="nav-text">ğŸ“Š æ ¸å¿ƒå·®å¼‚å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%A7-%E4%BB%A3%E7%A0%81%E5%B1%82%E9%9D%A2%E7%9A%84%E5%85%B7%E4%BD%93%E5%B7%AE%E5%BC%82"><span class="nav-text">ğŸ”§ ä»£ç å±‚é¢çš„å…·ä½“å·®å¼‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%8E%AF-%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97"><span class="nav-text">ğŸ¯ é€‰æ‹©æŒ‡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%92%A1-%E5%AE%9E%E9%99%85%E5%BB%BA%E8%AE%AE"><span class="nav-text">ğŸ’¡ å®é™…å»ºè®®</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%8F%8C%E8%BE%B9"><span class="nav-text">3. åŒè¾¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%A7-RDMA%E9%80%9A%E4%BF%A1%E5%9F%BA%E7%A1%80%E7%A4%BA%E4%BE%8B"><span class="nav-text">ğŸ”§ RDMAé€šä¿¡åŸºç¡€ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%92%BB-%E7%BC%96%E8%AF%91%E4%B8%8E%E8%BF%90%E8%A1%8C"><span class="nav-text">ğŸ’» ç¼–è¯‘ä¸è¿è¡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%8D-%E4%BB%A3%E7%A0%81%E5%85%B3%E9%94%AE%E7%82%B9%E8%AF%B4%E6%98%8E"><span class="nav-text">ğŸ” ä»£ç å…³é”®ç‚¹è¯´æ˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9B%A0-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E8%80%83%E8%99%91"><span class="nav-text">ğŸ›  å®é™…åº”ç”¨è€ƒè™‘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%8D%95%E8%BE%B9"><span class="nav-text">4. å•è¾¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%A7-RDMA%E5%8D%95%E8%BE%B9%E5%86%99%E5%85%A5%E7%A4%BA%E4%BE%8B"><span class="nav-text">ğŸ”§ RDMAå•è¾¹å†™å…¥ç¤ºä¾‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%94%8D-RDMA%E5%8D%95%E8%BE%B9%E6%93%8D%E4%BD%9C%E5%85%B3%E9%94%AE%E7%89%B9%E7%82%B9"><span class="nav-text">ğŸ” RDMAå•è¾¹æ“ä½œå…³é”®ç‰¹ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%9B%A0-%E7%BC%96%E8%AF%91%E4%B8%8E%E8%BF%90%E8%A1%8C"><span class="nav-text">ğŸ›  ç¼–è¯‘ä¸è¿è¡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%F0%9F%92%A1-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E8%80%83%E8%99%91"><span class="nav-text">ğŸ’¡ å®é™…åº”ç”¨è€ƒè™‘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">å‚è€ƒ</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2026&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Ethereal</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br>
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.2.1</a>
        </div>
        
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>





    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
