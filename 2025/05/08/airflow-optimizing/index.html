<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Ethereal">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2025/05/08/airflow-optimizing/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="1. 调度优化1.1 概念理解1.1.1 Executor是airflow部署的模式，更改后必须重启airflow才可以生效。  本地Executor  Airflow 任务在调度器进程内部本地运行。优点: 非常易于使用，速度快，延迟极低，设置要求少。缺点: 功能有限，并与 Airflow 调度器共享资源。   远程Executor  队列&#x2F;批处理 Executor  CeleryExe">
<meta property="og:type" content="article">
<meta property="og:title" content="airflow optimizing">
<meta property="og:url" content="http://example.com/2025/05/08/airflow-optimizing/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. 调度优化1.1 概念理解1.1.1 Executor是airflow部署的模式，更改后必须重启airflow才可以生效。  本地Executor  Airflow 任务在调度器进程内部本地运行。优点: 非常易于使用，速度快，延迟极低，设置要求少。缺点: 功能有限，并与 Airflow 调度器共享资源。   远程Executor  队列&#x2F;批处理 Executor  CeleryExe">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://airflow.org.cn/docs/apache-airflow-providers-celery/stable/_images/run_task_on_celery_executor.png">
<meta property="og:image" content="https://developer.qcloudimg.com/http-save/yehe-1293914/99b06eba24bb908bec12eb3ad08a8cba.png">
<meta property="article:published_time" content="2025-05-08T09:21:54.000Z">
<meta property="article:modified_time" content="2025-05-22T11:27:58.680Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://airflow.org.cn/docs/apache-airflow-providers-celery/stable/_images/run_task_on_celery_executor.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-favicon.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-favicon.svg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/redefine-favicon.svg">
    <!--- Page Info-->
    
    <title>
        
            airflow optimizing -
        
        Ethereal&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">

    <!--- Font Part-->
    
    
    
    

    <!--- Inject Part-->
    
    <script id="hexo-configurations">
    let Global = window.Global || {};
    Global.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    Global.theme_config = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"busuanzi_counter":{"enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"pjax":true,"open_graph":true,"google_analytics":{"enable":false,"id":null},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"Welcome to Ethereal's Blog","subtitle":{"text":["A willing horse needs no spur."],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.2.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Github":{"path":"https://github.com/Ethereal-O/","icon":"fa-brands fa-github"},"CSDN":{"path":"https://blog.csdn.net/weixin_51969975","icon":"fa-brands fa-stack-overflow"},"Links":{"icon":"fa-regular fa-link","submenus":{"Fontawesome":"https://fontawesome.com/search","Iconfont":"https://www.iconfont.cn/","Redefine":"https://redefine-docs.ohevan.com/introduction"}}},"search":{"enable":false,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"links":null},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2023/8/1 00:00:00"};
    Global.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    Global.data_config = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="main-content-container">

        <div class="main-content-header">
            <header class="navbar-container">
    
    <div class="navbar-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Ethereal&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        HOME
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    target="_blank" rel="noopener" href="https://github.com/Ethereal-O/"  >
                                    
                                        
                                            <i class="fa-brands fa-github"></i>
                                        
                                        GITHUB
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="" 
                                    target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_51969975"  >
                                    
                                        
                                            <i class="fa-brands fa-stack-overflow"></i>
                                        
                                        CSDN
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown" 
                                    href="#" onClick="return false;">
                                    
                                        
                                            <i class="fa-regular fa-link"></i>
                                        
                                        LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                                    
                                </a>
                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://fontawesome.com/search">FONTAWESOME
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://www.iconfont.cn/">ICONFONT
                                        </a>
                                        </li>
                                    
                                        <li>
                                        <a target="_blank" rel="noopener" href="https://redefine-docs.ohevan.com/introduction">REDEFINE
                                        </a>
                                        </li>
                                    
                                    </ul>
                                
                            </li>
                    
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="navbar-drawer">
        <ul class="drawer-navbar-list">
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        href="/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                HOME
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        target="_blank" rel="noopener" href="https://github.com/Ethereal-O/"  >
                             
                                
                                    <i class="fa-brands fa-github"></i>
                                
                                GITHUB
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="" 
                        target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_51969975"  >
                             
                                
                                    <i class="fa-brands fa-stack-overflow"></i>
                                
                                CSDN
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-navbar-item flex-center">
                        <a class="has-dropdown" 
                        href="#" onClick="return false;">
                            
                                
                                    <i class="fa-regular fa-link"></i>
                                
                                LINKS&nbsp;<i class="fa-solid fa-chevron-down"></i>
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                              
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://fontawesome.com/search">FONTAWESOME</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://www.iconfont.cn/">ICONFONT</a>
                            </li>
                        
                            <li class="dropdown-item flex-center">
                                <a class="dropdown-item" target="_blank" rel="noopener" href="https://redefine-docs.ohevan.com/introduction">REDEFINE</a>
                            </li>
                        
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">airflow optimizing</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/favicon.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Ethereal</span>
                            
                                <span class="author-label">Lv4</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-05-08 17:21:54</span>
        <span class="mobile">2025-05-08 17:21</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-05-22 19:27:58</span>
            <span class="mobile">2025-05-22 19:27</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h2 id="1-调度优化"><a href="#1-调度优化" class="headerlink" title="1. 调度优化"></a>1. 调度优化</h2><h3 id="1-1-概念理解"><a href="#1-1-概念理解" class="headerlink" title="1.1 概念理解"></a>1.1 概念理解</h3><h4 id="1-1-1-Executor"><a href="#1-1-1-Executor" class="headerlink" title="1.1.1 Executor"></a>1.1.1 Executor</h4><p>是airflow部署的模式，更改后必须重启airflow才可以生效。</p>
<ul>
<li><p>本地Executor</p>
<ul>
<li>Airflow 任务在调度器进程内部本地运行。<br><strong>优点</strong>: 非常易于使用，速度快，延迟极低，设置要求少。<br><strong>缺点</strong>: 功能有限，并与 Airflow 调度器共享资源。</li>
</ul>
</li>
<li><p>远程Executor</p>
<ul>
<li><p>队列&#x2F;批处理 Executor</p>
<ul>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow-providers-celery/stable/celery_executor.html"  title="(in apache-airflow-providers-celery v3.10.6)">CeleryExecutor <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li><p>在k8s中，会部署一个worker节点和一个redis节点（作为broker），scheduler只管推送至queue中，然后worker轮询方式获取任务。</p>
</li>
<li><p>scheduler会轮询检查DAG状态，将上一个已经完成的任务标记为完成并启动下一个任务的执行。</p>
</li>
</ul>
<p>因此，在启动任务前，存在以下步骤：</p>
<ol>
<li><p>parser分析DAG流图（主要因素：分析）</p>
</li>
<li><p>scheduler轮询检查是否有可以开始的任务，并放入queue内（主要时间因素：轮询）</p>
</li>
<li><p>queue通过数据库锁更新DAG状态（主要时间因素：锁）</p>
</li>
<li><p>worker轮询检查是否有新的任务可以被执行（主要时间因素：轮询）</p>
</li>
<li><p>获取任务（主要时间因素：下载任务）</p>
</li>
<li><p>启动执行</p>
</li>
<li><p>向数据库通知任务完成，更新状态</p>
</li>
</ol>
<p><img src="https://airflow.org.cn/docs/apache-airflow-providers-celery/stable/_images/run_task_on_celery_executor.png" alt="_images/run_task_on_celery_executor.png"></p>
</li>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow-providers-amazon/stable/executors/batch-executor.html"  title="(in apache-airflow-providers-amazon v9.6.1)">BatchExecutor <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li>通过docker执行任务</li>
</ul>
</li>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow-providers-edge3/stable/edge_executor.html"  title="(in apache-airflow-providers-edge3 v1.0.0)">EdgeExecutor <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> (实验性预发布)</p>
<ul>
<li>涉及边设备</li>
</ul>
</li>
</ul>
</li>
<li><p>容器化 Executor</p>
<ul>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow-providers-cncf-kubernetes/stable/kubernetes_executor.html"  title="(in apache-airflow-providers-cncf-kubernetes v10.4.3)">KubernetesExecutor <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li><p>通过Kubernetes来调度任务，所有的任务都被拆分成pod粒度</p>
<ul>
<li>pod启动时延（参考论文<a class="link"   target="_blank" rel="noopener" href="https://dl.acm.org/doi/abs/10.1145/3694715.3695947" >Unifying serverless and microservice workloads with SigmaOS | Proceedings of the ACM SIGOPS 30th Symposium on Operating Systems Principles <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>），主要是网络开销</li>
</ul>
</li>
<li><p>必须关闭flower, workers和redis</p>
</li>
<li><p>有用的场景</p>
<ul>
<li><p>有长时间运行的任务时，如果在任务运行时进行部署，任务将一直运行直到完成（或超时等）。但使用 CeleryExecutor，如果你设置了宽限期，任务只会运行到宽限期结束，届时任务将被终止。</p>
</li>
<li><p>任务在资源需求或镜像方面不是很统一</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow-providers-amazon/stable/executors/ecs-executor.html"  title="(in apache-airflow-providers-amazon v9.6.1)">EcsExecutor <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li>Amazon Elastic Container Service</li>
</ul>
</li>
<li><p>CeleryKubenetesExecutor</p>
<ul>
<li>celery和kubenetes的结合，根据queue决定是使用celery还是Kubenetes</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>并行使用多个Executor</p>
<ul>
<li><p>参数设置：</p>
<ul>
<li>executor: CeleryKubernetesExecutor（helm内）（已经废弃）</li>
</ul>
</li>
<li><p>新的方法：</p>
<ul>
<li>executor: “CeleryExecutor,KubernetesExecutor”</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="1-1-2-Parser"><a href="#1-1-2-Parser" class="headerlink" title="1.1.2 Parser"></a>1.1.2 Parser</h4><p>解析并更新DAG设置</p>
<p>参数设置</p>
<ul>
<li>parsing_processes（AIRFLOW__DAG_PROCESSOR__PARSING_PROCESSES）：DAG processor 可以并行运行多个进程来解析 dags。这定义了将运行的进程数量。</li>
</ul>
<h4 id="1-1-3-Scheduler"><a href="#1-1-3-Scheduler" class="headerlink" title="1.1.3 Scheduler"></a>1.1.3 Scheduler</h4><p>参数设置：</p>
<ul>
<li><p>[core] parallelism（AIRFLOW__CORE__PARALLELISM）：这定义了每个 Airflow 调度器可以同时运行的最大任务实例数量，与 worker 数量无关。通常，此值乘以集群中调度器的数量，就是元数据数据库中处于 running 状态的任务实例的最大数量。该值必须大于或等于 1。</p>
</li>
<li><p>[scheduler] dag_stale_not_seen_duration（AIRFLOW__SCHEDULER__DAG_STALE_NOT_SEEN_DURATION）：经过此秒数后，未被 Dag 处理器更新的 DAG 将被停用。</p>
</li>
<li><p>[scheduler] max_dagruns_per_loop_to_schedule（AIRFLOW__SCHEDULER__MAX_DAGRUNS_PER_LOOP_TO_SCHEDULE）：调度程序在调度和排队任务时应检查（并锁定）多少个 DagRun。</p>
</li>
<li><p>[scheduler] max_dagruns_to_create_per_loop（AIRFLOW__SCHEDULER__MAX_DAGRUNS_TO_CREATE_PER_LOOP）：每个调度程序循环中为多少个 DAG 创建 DagRun 的最大数量。</p>
</li>
<li><p>[scheduler] max_tis_per_query（AIRFLOW__SCHEDULER__MAX_TIS_PER_QUERY）：此项确定在每个调度程序循环中评估多少个任务实例进行调度。将其设置为 0 以使用 <code>[core] parallelism</code> 的值。</p>
</li>
<li><p>[scheduler] num_runs（AIRFLOW__SCHEDULER__NUM_RUNS）：尝试调度每个 DAG 文件的次数 -1 表示无限次数。</p>
</li>
<li><p>[scheduler] orphaned_tasks_check_interval（AIRFLOW__SCHEDULER__ORPHANED_TASKS_CHECK_INTERVAL）：调度程序应多久（以秒为单位）检查一次孤立任务和 SchedulerJobs。</p>
</li>
<li><p>[scheduler] <strong>scheduler_heartbeat_sec（AIRFLOW__SCHEDULER__SCHEDULER_HEARTBEAT_SEC）</strong>：调度器不断尝试触发新任务（有关更多信息，请参阅文档中的调度器部分）。这定义了调度器应多久运行一次（以秒为单位）。</p>
</li>
<li><p>[scheduler] scheduler_idle_sleep_time（AIRFLOW__SCHEDULER__SCHEDULER_IDLE_SLEEP_TIME）：控制调度器在循环之间休眠多长时间，但前提是循环中没有可做的事情。也就是说，如果它调度了某个任务，那么它将立即开始下一个循环迭代。</p>
</li>
<li><p>[scheduler] task_instance_heartbeat_sec（AIRFLOW__SCHEDULER__TASK_QUEUED_TIMEOUT）：任务在被重试或设置为失败之前可以处于排队状态的时间量。</p>
</li>
</ul>
<h4 id="1-1-3-Broker"><a href="#1-1-3-Broker" class="headerlink" title="1.1.3 Broker"></a>1.1.3 Broker</h4><table>
<thead>
<tr>
<th><strong>Broker类型</strong></th>
<th><strong>特点</strong></th>
<th><strong>适用场景</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>RabbitMQ</strong></td>
<td>高可靠、支持AMQP协议、功能丰富（如优先级队列）</td>
<td>生产环境首选，对消息可靠性要求高</td>
</tr>
<tr>
<td><strong>Redis</strong></td>
<td>简单轻量、性能高、支持Pub&#x2F;Sub模式</td>
<td>中小规模集群，对性能要求较高</td>
</tr>
<tr>
<td><strong>其他</strong></td>
<td>如Amazon SQS、Kafka（需定制）</td>
<td>特殊场景（如云原生、大数据架构）</td>
</tr>
</tbody></table>
<h4 id="1-1-4-Wroker"><a href="#1-1-4-Wroker" class="headerlink" title="1.1.4 Wroker"></a>1.1.4 Wroker</h4><p>参数设置：没有celery本身参数？celery中存在参数bundle_refresh_check_interval指定轮询间隔：猜测以下参数类似：min_heartbeat_interval</p>
<ul>
<li>[worker] min_heartbeat_interval（AIRFLOW__WORKERS__MIN_HEARTBEAT_INTERVAL）：工作节点与 API 服务器检查任务实例心跳状态以确认其仍然处于活动状态的最小间隔（以秒为单位）。</li>
</ul>
<h3 id="1-2-测试分析"><a href="#1-2-测试分析" class="headerlink" title="1.2 测试分析"></a>1.2 测试分析</h3><p>通过打印时间发现主要分成两部分：</p>
<ul>
<li><p>从下发命令到排队时间（取决于scheduler轮询并开始下发新任务间隔）</p>
<ul>
<li>通过缩短心跳时间可以减少结束到queue时间：scheduler_heartbeat_sec</li>
</ul>
</li>
<li><p>从排队到执行时间（取决于worker启动新任务间隔）</p>
<ul>
<li>queue时间还没有发现更改方式（AIRFLOW__WORKERS__MIN_HEARTBEAT_INTERVAL没有效果）</li>
</ul>
</li>
</ul>
<h3 id="1-3-尝试优化"><a href="#1-3-尝试优化" class="headerlink" title="1.3 尝试优化"></a>1.3 尝试优化</h3><h4 id="1-3-1-优化方式"><a href="#1-3-1-优化方式" class="headerlink" title="1.3.1 优化方式"></a>1.3.1 优化方式</h4><p>缩短轮询时间，增加并行度</p>
<div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AIRFLOW__SCHEDULER__SCHEDULER_HEARTBEAT_SEC:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">AIRFLOW__SCHEDULER__PARSING_PROCESSES:</span> <span class="number">4</span></span><br><span class="line"><span class="comment"># [core] 设置 parallelism 和 dag_concurrency</span></span><br><span class="line"><span class="attr">AIRFLOW__CORE__PARALLELISM:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">AIRFLOW__CORE__DAG_CONCURRENCY:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">AIRFLOW__CELERY__CELERYD_CONSUMER_POLL_INTERVAL:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">AIRFLOW__WORKERS__MIN_HEARTBEAT_INTERVAL:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<h4 id="1-3-2-运行日志"><a href="#1-3-2-运行日志" class="headerlink" title="1.3.2 运行日志"></a>1.3.2 运行日志</h4><p>打印时间</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[2025-05-08 10:40:28,959: INFO/MainProcess] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[cdb45479-493d-4328-ae0c-5cb793c76a62] received</span><br><span class="line">[2025-05-08 10:40:28,974: INFO/ForkPoolWorker-15] [cdb45479-493d-4328-ae0c-5cb793c76a62] Executing command in Celery: [&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;save_task&#x27;, &#x27;manual__2025-05-08T10:40:16.745026+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]</span><br><span class="line">[2025-05-08 10:40:29,139: INFO/ForkPoolWorker-15] Filling up the DagBag from /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-08 10:40:29,375: INFO/ForkPoolWorker-15] Running &lt;TaskInstance: download_bing.save_task manual__2025-05-08T10:40:16.745026+00:00 [queued]&gt; on host airflow-worker-0.airflow-worker.airflow.svc.cluster.local</span><br><span class="line">[2025-05-08 10:40:40,264: INFO/ForkPoolWorker-15] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[cdb45479-493d-4328-ae0c-5cb793c76a62] succeeded in 11.302474641997833s: None</span><br><span class="line">[2025-05-08 10:41:03,570: INFO/MainProcess] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[f0164707-0bc2-401e-931c-855c7fc9a0c4] received</span><br><span class="line">[2025-05-08 10:41:03,583: INFO/ForkPoolWorker-15] [f0164707-0bc2-401e-931c-855c7fc9a0c4] Executing command in Celery: [&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;request_task&#x27;, &#x27;manual__2025-05-08T10:41:03.285683+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]</span><br><span class="line">[2025-05-08 10:41:03,719: INFO/ForkPoolWorker-15] Filling up the DagBag from /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-08 10:41:03,923: INFO/ForkPoolWorker-15] Running &lt;TaskInstance: download_bing.request_task manual__2025-05-08T10:41:03.285683+00:00 [queued]&gt; on host airflow-worker-0.airflow-worker.airflow.svc.cluster.local</span><br><span class="line">[2025-05-08 10:41:14,857: INFO/ForkPoolWorker-15] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[f0164707-0bc2-401e-931c-855c7fc9a0c4] succeeded in 11.284130732004996s: None</span><br><span class="line">[2025-05-08 10:41:15,644: INFO/MainProcess] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[e8a51a0d-d621-4895-aa5a-ad2d1cc416f2] received</span><br><span class="line">[2025-05-08 10:41:15,657: INFO/ForkPoolWorker-15] [e8a51a0d-d621-4895-aa5a-ad2d1cc416f2] Executing command in Celery: [&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;save_task&#x27;, &#x27;manual__2025-05-08T10:41:03.285683+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]</span><br><span class="line">[2025-05-08 10:41:15,794: INFO/ForkPoolWorker-15] Filling up the DagBag from /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-08 10:41:15,989: INFO/ForkPoolWorker-15] Running &lt;TaskInstance: download_bing.save_task manual__2025-05-08T10:41:03.285683+00:00 [queued]&gt; on host airflow-worker-0.airflow-worker.airflow.svc.cluster.local</span><br><span class="line">[2025-05-08 10:41:26,872: INFO/ForkPoolWorker-15] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[e8a51a0d-d621-4895-aa5a-ad2d1cc416f2] succeeded in 11.225932340006693s: None</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2025-05-08, 10:41:04 UTC] &#123;logging_mixin.py:188&#125; INFO - 1746700864.6873255</span><br><span class="line">[2025-05-08, 10:41:16 UTC] &#123;logging_mixin.py:188&#125; INFO - 1746700876.7167912</span><br></pre></td></tr></table></figure></div>

<p>新任务进入排队（10:41:03,570）-&gt;worker开始执行（10:41:03,923）-&gt;真正开始执行（10:41:04）</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[2025-05-09 05:19:09,662: INFO/MainProcess] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[34b1c9f8-106f-4a57-b5db-e5372fd4d586] received</span><br><span class="line">[2025-05-09 05:19:09,662: DEBUG/MainProcess] TaskPool: Apply &lt;function fast_trace_task at 0x78c712290a60&gt; (args:(&#x27;airflow.providers.celery.executors.celery_executor_utils.execute_command&#x27;, &#x27;34b1c9f8-106f-4a57-b5db-e5372fd4d586&#x27;, &#123;&#x27;lang&#x27;: &#x27;py&#x27;, &#x27;task&#x27;: &#x27;airflow.providers.celery.executors.celery_executor_utils.execute_command&#x27;, &#x27;id&#x27;: &#x27;34b1c9f8-106f-4a57-b5db-e5372fd4d586&#x27;, &#x27;shadow&#x27;: None, &#x27;eta&#x27;: None, &#x27;expires&#x27;: None, &#x27;group&#x27;: None, &#x27;group_index&#x27;: None, &#x27;retries&#x27;: 0, &#x27;timelimit&#x27;: [None, None], &#x27;root_id&#x27;: &#x27;34b1c9f8-106f-4a57-b5db-e5372fd4d586&#x27;, &#x27;parent_id&#x27;: None, &#x27;argsrepr&#x27;: &quot;[[&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;request_task&#x27;, &#x27;manual__2025-05-09T05:19:09.480045+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]]&quot;, &#x27;kwargsrepr&#x27;: &#x27;&#123;&#125;&#x27;, &#x27;origin&#x27;: &#x27;gen7@airflow-scheduler-7d48d8794c-jg52n&#x27;, &#x27;ignore_result&#x27;: False, &#x27;replaced_task_nesting&#x27;: 0, &#x27;stamped_headers&#x27;: None, &#x27;stamps&#x27;: &#123;&#125;, &#x27;properties&#x27;: &#123;&#x27;correlation_id&#x27;: &#x27;34b1c9f8-106f-4a57-b5db-e5372fd4d586&#x27;, &#x27;reply_to&#x27;: &#x27;ce14b94e-9598-36d8-a3f1-efeefc50cd54&#x27;, &#x27;delivery_mode&#x27;: 2, &#x27;delivery_info&#x27;: &#123;&#x27;exchange&#x27;: &#x27;&#x27;, &#x27;routing_key&#x27;: &#x27;default&#x27;&#125;, &#x27;priority&#x27;: 0,... kwargs:&#123;&#125;)</span><br><span class="line">[2025-05-09 05:19:09,665: DEBUG/MainProcess] Task accepted: airflow.providers.celery.executors.celery_executor_utils.execute_command[34b1c9f8-106f-4a57-b5db-e5372fd4d586] pid:82</span><br><span class="line">[2025-05-09 05:19:09,676: INFO/ForkPoolWorker-15] [34b1c9f8-106f-4a57-b5db-e5372fd4d586] Executing command in Celery: [&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;request_task&#x27;, &#x27;manual__2025-05-09T05:19:09.480045+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]</span><br><span class="line">[2025-05-09 05:19:09,707: DEBUG/ForkPoolWorker-15] Calling callbacks: [&lt;function default_action_log at 0x78c7167a0b80&gt;]</span><br><span class="line">[2025-05-09 05:19:09,738: DEBUG/ForkPoolWorker-15] Loading plugins</span><br><span class="line">[2025-05-09 05:19:09,738: DEBUG/ForkPoolWorker-15] Loading plugins from directory: /opt/airflow/plugins</span><br><span class="line">[2025-05-09 05:19:09,739: DEBUG/ForkPoolWorker-15] Loading plugins from entrypoints</span><br><span class="line">[2025-05-09 05:19:09,739: DEBUG/ForkPoolWorker-15] Importing entry_point plugin openlineage</span><br><span class="line">[2025-05-09 05:19:09,812: DEBUG/ForkPoolWorker-15] Loading 1 plugin(s) took 0.07 seconds</span><br><span class="line">[2025-05-09 05:19:09,813: INFO/ForkPoolWorker-15] Filling up the DagBag from /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-09 05:19:09,815: DEBUG/ForkPoolWorker-15] Importing /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-09 05:19:09,823: DEBUG/ForkPoolWorker-15] Loaded DAG &lt;DAG: download_bing&gt;</span><br><span class="line">[2025-05-09 05:19:10,003: DEBUG/ForkPoolWorker-15] Plugins are already loaded. Skipping.</span><br><span class="line">[2025-05-09 05:19:10,003: DEBUG/ForkPoolWorker-15] Integrate DAG plugins</span><br><span class="line">[2025-05-09 05:19:10,008: DEBUG/ForkPoolWorker-15] previous_execution_date was called</span><br><span class="line">[2025-05-09 05:19:10,018: INFO/ForkPoolWorker-15] Running &lt;TaskInstance: download_bing.request_task manual__2025-05-09T05:19:09.480045+00:00 [queued]&gt; on host airflow-worker-0.airflow-worker.airflow.svc.cluster.local</span><br><span class="line">[2025-05-09 05:19:10,018: DEBUG/ForkPoolWorker-15] Disposing DB connection pool (PID 694)</span><br><span class="line">[2025-05-09 05:19:10,019: DEBUG/ForkPoolWorker-15] Setting up DB connection pool (PID 694)</span><br><span class="line">[2025-05-09 05:19:10,019: DEBUG/ForkPoolWorker-15] settings.prepare_engine_args(): Using NullPool</span><br><span class="line">[2025-05-09 05:19:10,383: DEBUG/MainProcess] pidbox received method enable_events() [reply_to:None ticket:None]</span><br><span class="line">[2025-05-09 05:19:15,384: DEBUG/MainProcess] pidbox received method enable_events() [reply_to:None ticket:None]</span><br><span class="line">[2025-05-09 05:19:20,384: DEBUG/MainProcess] pidbox received method enable_events() [reply_to:None ticket:None]</span><br><span class="line">[2025-05-09 05:19:20,843: DEBUG/MainProcess] pidbox received method ping() [reply_to:&#123;&#x27;exchange&#x27;: &#x27;reply.celery.pidbox&#x27;, &#x27;routing_key&#x27;: &#x27;e39109c1-1692-3932-8384-c1cccb7baf1a&#x27;&#125; ticket:5bb21c32-2bae-415d-9d34-ff1b00e7270e]</span><br><span class="line">[2025-05-09 05:19:20,981: DEBUG/ForkPoolWorker-15] Calling callbacks: []</span><br><span class="line">[2025-05-09 05:19:21,008: INFO/ForkPoolWorker-15] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[34b1c9f8-106f-4a57-b5db-e5372fd4d586] succeeded in 11.343424211023375s: None</span><br><span class="line">[2025-05-09 05:19:21,100: INFO/MainProcess] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[6291141f-dbc2-4fd8-a518-81e017134130] received</span><br><span class="line">[2025-05-09 05:19:21,101: DEBUG/MainProcess] TaskPool: Apply &lt;function fast_trace_task at 0x78c712290a60&gt; (args:(&#x27;airflow.providers.celery.executors.celery_executor_utils.execute_command&#x27;, &#x27;6291141f-dbc2-4fd8-a518-81e017134130&#x27;, &#123;&#x27;lang&#x27;: &#x27;py&#x27;, &#x27;task&#x27;: &#x27;airflow.providers.celery.executors.celery_executor_utils.execute_command&#x27;, &#x27;id&#x27;: &#x27;6291141f-dbc2-4fd8-a518-81e017134130&#x27;, &#x27;shadow&#x27;: None, &#x27;eta&#x27;: None, &#x27;expires&#x27;: None, &#x27;group&#x27;: None, &#x27;group_index&#x27;: None, &#x27;retries&#x27;: 0, &#x27;timelimit&#x27;: [None, None], &#x27;root_id&#x27;: &#x27;6291141f-dbc2-4fd8-a518-81e017134130&#x27;, &#x27;parent_id&#x27;: None, &#x27;argsrepr&#x27;: &quot;[[&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;save_task&#x27;, &#x27;manual__2025-05-09T05:19:09.480045+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]]&quot;, &#x27;kwargsrepr&#x27;: &#x27;&#123;&#125;&#x27;, &#x27;origin&#x27;: &#x27;gen7@airflow-scheduler-7d48d8794c-jg52n&#x27;, &#x27;ignore_result&#x27;: False, &#x27;replaced_task_nesting&#x27;: 0, &#x27;stamped_headers&#x27;: None, &#x27;stamps&#x27;: &#123;&#125;, &#x27;properties&#x27;: &#123;&#x27;correlation_id&#x27;: &#x27;6291141f-dbc2-4fd8-a518-81e017134130&#x27;, &#x27;reply_to&#x27;: &#x27;ce14b94e-9598-36d8-a3f1-efeefc50cd54&#x27;, &#x27;delivery_mode&#x27;: 2, &#x27;delivery_info&#x27;: &#123;&#x27;exchange&#x27;: &#x27;&#x27;, &#x27;routing_key&#x27;: &#x27;default&#x27;&#125;, &#x27;priority&#x27;: 0, &#x27;body_encoding&#x27;:... kwargs:&#123;&#125;)</span><br><span class="line">[2025-05-09 05:19:21,103: DEBUG/MainProcess] Task accepted: airflow.providers.celery.executors.celery_executor_utils.execute_command[6291141f-dbc2-4fd8-a518-81e017134130] pid:82</span><br><span class="line">[2025-05-09 05:19:21,119: INFO/ForkPoolWorker-15] [6291141f-dbc2-4fd8-a518-81e017134130] Executing command in Celery: [&#x27;airflow&#x27;, &#x27;tasks&#x27;, &#x27;run&#x27;, &#x27;download_bing&#x27;, &#x27;save_task&#x27;, &#x27;manual__2025-05-09T05:19:09.480045+00:00&#x27;, &#x27;--local&#x27;, &#x27;--subdir&#x27;, &#x27;DAGS_FOLDER/test.py&#x27;]</span><br><span class="line">[2025-05-09 05:19:21,149: DEBUG/ForkPoolWorker-15] Calling callbacks: [&lt;function default_action_log at 0x78c7167a0b80&gt;]</span><br><span class="line">[2025-05-09 05:19:21,189: DEBUG/ForkPoolWorker-15] Loading plugins</span><br><span class="line">[2025-05-09 05:19:21,190: DEBUG/ForkPoolWorker-15] Loading plugins from directory: /opt/airflow/plugins</span><br><span class="line">[2025-05-09 05:19:21,190: DEBUG/ForkPoolWorker-15] Loading plugins from entrypoints</span><br><span class="line">[2025-05-09 05:19:21,190: DEBUG/ForkPoolWorker-15] Importing entry_point plugin openlineage</span><br><span class="line">[2025-05-09 05:19:21,263: DEBUG/ForkPoolWorker-15] Loading 1 plugin(s) took 0.07 seconds</span><br><span class="line">[2025-05-09 05:19:21,264: INFO/ForkPoolWorker-15] Filling up the DagBag from /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-09 05:19:21,265: DEBUG/ForkPoolWorker-15] Importing /opt/airflow/dags/test.py</span><br><span class="line">[2025-05-09 05:19:21,273: DEBUG/ForkPoolWorker-15] Loaded DAG &lt;DAG: download_bing&gt;</span><br><span class="line">[2025-05-09 05:19:21,448: DEBUG/ForkPoolWorker-15] Plugins are already loaded. Skipping.</span><br><span class="line">[2025-05-09 05:19:21,449: DEBUG/ForkPoolWorker-15] Integrate DAG plugins</span><br><span class="line">[2025-05-09 05:19:21,453: DEBUG/ForkPoolWorker-15] previous_execution_date was called</span><br><span class="line">[2025-05-09 05:19:21,462: INFO/ForkPoolWorker-15] Running &lt;TaskInstance: download_bing.save_task manual__2025-05-09T05:19:09.480045+00:00 [queued]&gt; on host airflow-worker-0.airflow-worker.airflow.svc.cluster.local</span><br><span class="line">[2025-05-09 05:19:21,462: DEBUG/ForkPoolWorker-15] Disposing DB connection pool (PID 729)</span><br><span class="line">[2025-05-09 05:19:21,463: DEBUG/ForkPoolWorker-15] Setting up DB connection pool (PID 729)</span><br><span class="line">[2025-05-09 05:19:21,463: DEBUG/ForkPoolWorker-15] settings.prepare_engine_args(): Using NullPool</span><br><span class="line">[2025-05-09 05:19:25,384: DEBUG/MainProcess] pidbox received method enable_events() [reply_to:None ticket:None]</span><br><span class="line">[2025-05-09 05:19:30,383: DEBUG/MainProcess] pidbox received method enable_events() [reply_to:None ticket:None]</span><br><span class="line">[2025-05-09 05:19:32,355: DEBUG/ForkPoolWorker-15] Calling callbacks: []</span><br><span class="line">[2025-05-09 05:19:32,387: INFO/ForkPoolWorker-15] Task airflow.providers.celery.executors.celery_executor_utils.execute_command[6291141f-dbc2-4fd8-a518-81e017134130] succeeded in 11.284129409003071s: None</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2025-05-09, 05:19:10 UTC] &#123;logging_mixin.py:188&#125; INFO - 1746767950.8249474</span><br><span class="line">[2025-05-09, 05:19:22 UTC] &#123;logging_mixin.py:188&#125; INFO - 1746767962.2026312</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">airflow tasks run download_bing save_task manual__2025-05-09T05:19:09.480045+00:00</span></span><br><span class="line">...</span><br><span class="line">[2025-05-10T04:49:16.545+0000] &#123;cli_action_loggers.py:67&#125; DEBUG - Calling callbacks: [&lt;function default_action_log at 0x7e4c4b906820&gt;]</span><br><span class="line">[2025-05-10T04:49:16.572+0000] &#123;plugins_manager.py:328&#125; DEBUG - Loading plugins</span><br><span class="line">[2025-05-10T04:49:16.573+0000] &#123;plugins_manager.py:254&#125; DEBUG - Loading plugins from directory: /opt/***/plugins</span><br><span class="line">[2025-05-10T04:49:16.573+0000] &#123;plugins_manager.py:234&#125; DEBUG - Loading plugins from entrypoints</span><br><span class="line">[2025-05-10T04:49:16.595+0000] &#123;plugins_manager.py:237&#125; DEBUG - Importing entry_point plugin openlineage</span><br><span class="line">[2025-05-10T04:49:16.727+0000] &#123;plugins_manager.py:346&#125; DEBUG - Loading 1 plugin(s) took 0.15 seconds</span><br><span class="line">[2025-05-10T04:49:16.728+0000] &#123;dagbag.py:540&#125; INFO - Filling up the DagBag from /opt/***/dags</span><br><span class="line">[2025-05-10T04:49:16.730+0000] &#123;dagbag.py:332&#125; DEBUG - Importing /opt/***/dags/test.py</span><br><span class="line">[2025-05-10T04:49:16.752+0000] &#123;dagbag.py:506&#125; DEBUG - Loaded DAG &lt;DAG: download_bing&gt;</span><br><span class="line">[2025-05-10T04:49:16.753+0000] &#123;dagbag.py:332&#125; DEBUG - Importing /opt/***/dags/hello.py</span><br><span class="line">[2025-05-10T04:49:16.757+0000] &#123;dagbag.py:506&#125; DEBUG - Loaded DAG &lt;DAG: b_hello&gt;</span><br><span class="line">[2025-05-10T04:49:16.910+0000] &#123;plugins_manager.py:322&#125; DEBUG - Plugins are already loaded. Skipping.</span><br><span class="line">[2025-05-10T04:49:16.911+0000] &#123;plugins_manager.py:506&#125; DEBUG - Integrate DAG plugins</span><br><span class="line">[2025-05-10T04:49:16.915+0000] &#123;taskinstance.py:991&#125; DEBUG - previous_execution_date was called</span><br><span class="line">[2025-05-10T04:49:16.923+0000] &#123;task_command.py:423&#125; INFO - Running &lt;TaskInstance: download_bing.save_task manual__2025-05-09T05:19:09.480045+00:00 [success]&gt; on host ***-worker-0.***-worker.***.svc.cluster.local</span><br><span class="line">[2025-05-10T04:49:16.923+0000] &#123;settings.py:386&#125; DEBUG - Disposing DB connection pool (PID 32686)</span><br><span class="line">[2025-05-10T04:49:16.924+0000] &#123;settings.py:249&#125; DEBUG - Setting up DB connection pool (PID 32686)</span><br><span class="line">[2025-05-10T04:49:16.924+0000] &#123;settings.py:318&#125; DEBUG - settings.prepare_engine_args(): Using NullPool</span><br><span class="line">[2025-05-10T04:49:18.554+0000] &#123;cli_action_loggers.py:85&#125; DEBUG - Calling callbacks: []</span><br><span class="line">[2025-05-10T04:49:18.554+0000] &#123;settings.py:386&#125; DEBUG - Disposing DB connection pool (PID 32686)</span><br></pre></td></tr></table></figure></div>

<h4 id="1-3-3-修改Broker"><a href="#1-3-3-修改Broker" class="headerlink" title="1.3.3 修改Broker"></a>1.3.3 修改Broker</h4><p>rabbitmq时间损耗：</p>
<ol>
<li><p>加入环境变量优化前</p>
<ol>
<li>1747293379.924484-&gt;1747293381.4033878（1.479）</li>
</ol>
</li>
<li><p>加入环境变量优化后</p>
<ol>
<li><p>1747294250.2575343-&gt;1747294251.8361712（1.579）</p>
</li>
<li><p>1747294511.4867296-&gt;1747294513.37435（1.888）</p>
</li>
</ol>
</li>
</ol>
<p>redis时间损耗：</p>
<ol>
<li><p>加入环境变量优化前</p>
<ol>
<li><p>1747296261.2109053-&gt;1747296263.5157278（2.305）</p>
</li>
<li><p>1747295348.6995502-&gt;1747295350.9857132（2.286）</p>
</li>
</ol>
</li>
<li><p>加入环境变量优化后</p>
<ol>
<li><p>1747295391.1667778-&gt;1747295393.4209657（2.26）</p>
</li>
<li><p>1747296451.4672449-&gt;1747296453.208179（1.741）</p>
</li>
</ol>
</li>
</ol>
<h4 id="1-3-4-使用KubernetesPodOperator"><a href="#1-3-4-使用KubernetesPodOperator" class="headerlink" title="1.3.4 使用KubernetesPodOperator"></a>1.3.4 使用KubernetesPodOperator</h4><p>使用官方版本helm，并且注意要将配置修改：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">multiNamespaceMode: true</span><br></pre></td></tr></table></figure></div>

<p>编写如下脚本：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> airflow <span class="keyword">import</span> DAG</span><br><span class="line"><span class="keyword">from</span> airflow.operators.python <span class="keyword">import</span> PythonOperator</span><br><span class="line"><span class="keyword">from</span> airflow.providers.cncf.kubernetes.operators.pod <span class="keyword">import</span> KubernetesPodOperator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> DAG(</span><br><span class="line">    dag_id=<span class="string">&#x27;download_bing&#x27;</span>,</span><br><span class="line">    tags=[<span class="string">&#x27;test&#x27;</span>], <span class="comment"># DAG的tag标签，用于分类</span></span><br><span class="line">) <span class="keyword">as</span> dag:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(time.time())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">import</span> requests</span><br><span class="line">        resp = requests.get(<span class="string">&quot;https://www.bing.com/HPImageArchive.aspx?format=js&amp;idx=1&amp;n=10&amp;mkt=en-US&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;hello2&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(time.time())</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/opt/airflow/results.txt&quot;</span>, <span class="string">&quot;a+&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用PythonOperator执行Python函数</span></span><br><span class="line">    request_task = PythonOperator(</span><br><span class="line">        task_id=<span class="string">&quot;request_task&quot;</span>,</span><br><span class="line">        python_callable=request</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    save_task = PythonOperator(</span><br><span class="line">        task_id=<span class="string">&quot;save_task&quot;</span>,</span><br><span class="line">        python_callable=save</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    k = KubernetesPodOperator(</span><br><span class="line">        task_id=<span class="string">&quot;example_task&quot;</span>,</span><br><span class="line">        name=<span class="string">&quot;example_pod&quot;</span>,</span><br><span class="line">        namespace=<span class="string">&quot;default&quot;</span>,</span><br><span class="line">        image=<span class="string">&quot;debian&quot;</span>,</span><br><span class="line">        cmds=[<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-cx&quot;</span>],</span><br><span class="line">        arguments=[<span class="string">&quot;date +%Y-%m-%d&#x27; &#x27;%H:%M:%S.%3N&quot;</span>],</span><br><span class="line">        labels=&#123;<span class="string">&quot;example&quot;</span>: <span class="string">&quot;label&quot;</span>&#125;,</span><br><span class="line">        get_logs=<span class="literal">True</span>,</span><br><span class="line">        is_delete_operator_pod=<span class="literal">True</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    request_task &gt;&gt; save_task</span><br><span class="line">    save_task &gt;&gt; k</span><br></pre></td></tr></table></figure></div>

<p>使用KubernetesPodOperator消耗：</p>
<p>前一个输出：1747749304.166512</p>
<p>后一个输出（KubernetesPodOperator）：2025-05-20 13:55:07.802</p>
<p>大约耗费：3.636s</p>
<h4 id="1-3-5-使用多Executor并存：指定KubernetesExecutor"><a href="#1-3-5-使用多Executor并存：指定KubernetesExecutor" class="headerlink" title="1.3.5 使用多Executor并存：指定KubernetesExecutor"></a>1.3.5 使用多Executor并存：指定KubernetesExecutor</h4><p>配置：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">多execotor并存</span></span><br><span class="line">executor: &quot;CeleryExecutor,KubernetesExecutor&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同时要修改files/pod-template-file.kubernetes-helm-yaml</span></span><br><span class="line">        - name: AIRFLOW__CORE__EXECUTOR</span><br><span class="line">          value: &#123;&#123; .Values.executor | quote &#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>使用以下方式指定：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b = BashOperator(</span><br><span class="line">    task_id=<span class="string">&quot;my_task_in_its_own_pod&quot;</span>,</span><br><span class="line">    executor=<span class="string">&quot;KubernetesExecutor&quot;</span>,</span><br><span class="line">    bash_command=<span class="string">&quot;echo hello &amp; sleep 10&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>但是目前还无法看到log，所以无法计时。</p>
<h4 id="1-3-6-调用链"><a href="#1-3-6-调用链" class="headerlink" title="1.3.6 调用链"></a>1.3.6 调用链</h4><p>task_run(airflow&#x2F;cli&#x2F;commands&#x2F;task_command.py)</p>
<p>-&gt; 1. get_dag(airflow&#x2F;utils&#x2F;cli.py)    <strong>2. DAG::get_task(airflow&#x2F;models&#x2F;dag.py)    3. _get_ti(airflow&#x2F;cli&#x2F;commands&#x2F;task_command.py)</strong>   4. TaskInstance::init_run_context(airflow-core&#x2F;src&#x2F;airflow&#x2F;models&#x2F;taskinstance.py)</p>
<p>-&gt; 4. TaskInstance::get_template_context(airflow&#x2F;models&#x2F;taskinstance.py)</p>
<p>-&gt; 4. integrate_macros_plugins(airflow&#x2F;plugins_manager.py)</p>
<p>-&gt; 5. reconfigure_orm(airflow&#x2F;settings.py)</p>
<p>-&gt; 6. _run_raw_task(airflow&#x2F;models&#x2F;taskinstance.py)</p>
<p>观察发现可能是以下几个函数调用时间过长：</p>
<ol>
<li><p>DAG::get_task(airflow&#x2F;models&#x2F;dag.py)</p>
</li>
<li><p>_get_ti(airflow&#x2F;cli&#x2F;commands&#x2F;task_command.py)</p>
</li>
<li><p><strong>_run_raw_task(airflow&#x2F;models&#x2F;taskinstance.py)</strong></p>
</li>
</ol>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2025-05-10T04:49:18.554+0000] &#123;cli_action_loggers.py:85&#125; DEBUG - Calling callbacks: []</span><br><span class="line">[2025-05-10T04:49:18.554+0000] &#123;settings.py:386&#125; DEBUG - Disposing DB connection pool (PID 32686)</span><br></pre></td></tr></table></figure></div>

<p>都是执行程序结束后的退出时的调用</p>
<h3 id="1-4-对比选型"><a href="#1-4-对比选型" class="headerlink" title="1.4 对比选型"></a>1.4 对比选型</h3><h4 id="1-4-1-argo"><a href="#1-4-1-argo" class="headerlink" title="1.4.1 argo"></a>1.4.1 argo</h4><p>优点</p>
<ul>
<li>支持更复杂的工作流设计，包括<strong>循环、递归和条件逻辑</strong>，适合需要高度控制和灵活性的复杂任务。其工作流以 YAML 或 JSON 格式定义</li>
</ul>
<p>缺点</p>
<ul>
<li>使用 Kubernetes 的 CronJob 来调度工作流，调度能力依赖于 Kubernetes</li>
</ul>
<h4 id="1-4-2-kubeflow"><a href="#1-4-2-kubeflow" class="headerlink" title="1.4.2 kubeflow"></a>1.4.2 kubeflow</h4><p>优点</p>
<ul>
<li><p><strong>Kubeflow</strong> 在 <strong>机器学习、分布式计算、资源密集型任务</strong> 中更快。因为依赖于k8s，可以更好利用资源。</p>
<ul>
<li><strong>Airflow</strong> 在 <strong>轻量级任务、短时任务调度、非容器化环境</strong> 中更快。</li>
</ul>
</li>
<li><p>提供很多ML相关包，例如类似jupter notebook的kubeflow notebooks</p>
</li>
<li><p>其中kubeflow pipeline基于argo实现，相比于argo能有更多ML内容，增强了持久化层。</p>
</li>
</ul>
<p>缺点</p>
<ul>
<li>同样需要每个任务启动新的Pod</li>
</ul>
<ul>
<li>kubeflow也不支持定义循环</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://developer.qcloudimg.com/http-save/yehe-1293914/99b06eba24bb908bec12eb3ad08a8cba.png"
                      alt="99b06eba24bb908bec12eb3ad08a8cba"
                ></p>
<h3 id="1-5-Celery优化"><a href="#1-5-Celery优化" class="headerlink" title="1.5 Celery优化"></a>1.5 Celery优化</h3><h4 id="1-5-1-Broker-Connection-Pools（连接池数目）"><a href="#1-5-1-Broker-Connection-Pools（连接池数目）" class="headerlink" title="1.5.1 Broker Connection Pools（连接池数目）"></a>1.5.1 Broker Connection Pools（连接池数目）</h4><ul>
<li><a target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html#std-setting-broker_pool_limit"><code>broker_pool_limit</code></a></li>
</ul>
<h4 id="1-5-2-Using-Transient-Queues（不需要持久化的队列）"><a href="#1-5-2-Using-Transient-Queues（不需要持久化的队列）" class="headerlink" title="1.5.2 Using Transient Queues（不需要持久化的队列）"></a>1.5.2 Using Transient Queues（不需要持久化的队列）</h4><ul>
<li><p>by using <a target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html#std-setting-task_routes"><code>task_routes</code></a>:</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task_routes = &#123; <span class="string">&#x27;proj.tasks.add&#x27;</span>: &#123;<span class="string">&#x27;queue&#x27;</span>: <span class="string">&#x27;celery&#x27;</span>, <span class="string">&#x27;delivery_mode&#x27;</span>: <span class="string">&#x27;transient&#x27;</span>&#125;&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h4 id="1-5-3-Prefetch-Limits（预取数量，对于任务执行时间短的可以设置较大数值）"><a href="#1-5-3-Prefetch-Limits（预取数量，对于任务执行时间短的可以设置较大数值）" class="headerlink" title="1.5.3 Prefetch Limits（预取数量，对于任务执行时间短的可以设置较大数值）"></a>1.5.3 Prefetch Limits（预取数量，对于任务执行时间短的可以设置较大数值）</h4><ul>
<li><a target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html#std-setting-worker_prefetch_multiplier"><code>worker_prefetch_multiplier</code></a></li>
</ul>
<h4 id="1-5-4-Reserve-one-task-at-a-time（留存任务）"><a href="#1-5-4-Reserve-one-task-at-a-time（留存任务）" class="headerlink" title="1.5.4 Reserve one task at a time（留存任务）"></a>1.5.4 Reserve one task at a time（留存任务）</h4><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">task_acks_late = <span class="literal">True</span></span><br><span class="line">worker_prefetch_multiplier = <span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<h4 id="1-5-5-其他概念"><a href="#1-5-5-其他概念" class="headerlink" title="1.5.5 其他概念"></a>1.5.5 其他概念</h4><h5 id="1-5-5-1-定时任务（Periodic-Tasks）"><a href="#1-5-5-1-定时任务（Periodic-Tasks）" class="headerlink" title="1.5.5.1 定时任务（Periodic Tasks）"></a>1.5.5.1 定时任务（Periodic Tasks）</h5><p>通过<strong>celery beat</strong>调度程序调度</p>
<h5 id="1-5-5-2-应用（Application）"><a href="#1-5-5-2-应用（Application）" class="headerlink" title="1.5.5.2 应用（Application）"></a>1.5.5.2 应用（Application）</h5><p>类似flask</p>
<h5 id="1-5-5-3-队列（Queue）"><a href="#1-5-5-3-队列（Queue）" class="headerlink" title="1.5.5.3 队列（Queue）"></a>1.5.5.3 队列（Queue）</h5><p>指定任务调度的队列<a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/calling.html#id11" >Routing options <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add.apply_async(queue=<span class="string">&#x27;priority.high&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h5 id="1-5-5-4-任务（Tasks）"><a href="#1-5-5-4-任务（Tasks）" class="headerlink" title="1.5.5.4 任务（Tasks）"></a>1.5.5.4 任务（Tasks）</h5><p>优化建议：</p>
<ol>
<li><p>一般来说，最好将问题分解为许多小任务</p>
</li>
<li><p>最好的办法是在内存中有一份副本</p>
</li>
<li><p>注意竞争</p>
</li>
</ol>
<h5 id="1-5-5-5-工作节点（Worker）"><a href="#1-5-5-5-工作节点（Worker）" class="headerlink" title="1.5.5.5 工作节点（Worker）"></a>1.5.5.5 工作节点（Worker）</h5><ul>
<li><p>并发：默认为机器上的CPU数量-&gt;k8s环境中指Pod分配到的CPU数量</p>
</li>
<li><p>自动缩放：<a target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/reference/cli.html#cmdoption-celery-worker-autoscale"><code>--autoscale</code></a>选项</p>
</li>
<li><p>并发控制</p>
<ul>
<li><p>prefork：默认选项，非常适合CPU受限的任务和大多数用例。</p>
</li>
<li><p>eventlet和gevent：这些模型专为IO受限的任务而设计，使用greenlets实现高并发性。请注意，某些功能，如soft_timeout，在这些模式下不可用。</p>
</li>
<li><p>solo：在主线程中按顺序执行任务。</p>
</li>
<li><p>threads：利用线程实现并发。</p>
</li>
<li><p>custom：允许通过环境变量指定自定义工作池实现。</p>
</li>
</ul>
</li>
</ul>
<h5 id="1-5-5-6-缓存池"><a href="#1-5-5-6-缓存池" class="headerlink" title="1.5.5.6 缓存池"></a>1.5.5.6 缓存池</h5><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cache_backend_options = &#123;</span><br><span class="line">    <span class="string">&#x27;binary&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&#x27;behaviors&#x27;</span>: &#123;<span class="string">&#x27;tcp_nodelay&#x27;</span>: <span class="literal">True</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><a target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html#std-setting-cache_backend_options"><code>cache_backend_options</code></a></p>
<h5 id="1-5-5-7-详细配置"><a href="#1-5-5-7-详细配置" class="headerlink" title="1.5.5.7 详细配置"></a>1.5.5.7 详细配置</h5><p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html" >Configuration and defaults — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.ac.cn/docs/apache-airflow/stable/configurations-ref.html#task-instance-heartbeat-sec" >配置参考 — Airflow 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow/stable/core-concepts/params.html" >参数 — Airflow 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.ac.cn/docs/apache-airflow/stable/administration-and-deployment/scheduler.html#what-resources-might-limit-scheduler-s-performance" >调度器 — Airflow 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.ac.cn/docs/apache-airflow-providers-celery/stable/celery_executor.html" >Celery Executor — apache-airflow-providers-celery 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40046357/article/details/129273102" >Airflow Celery Executor 架构与任务执行过程-CSDN博客 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.ac.cn/docs/apache-airflow-providers-celery/stable/celery_kubernetes_executor.html" >CeleryKubernetes 执行器 — apache-airflow-providers-celery 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.ac.cn/docs/apache-airflow-providers-celery/stable/cli-ref.html" >Celery 执行器命令 — apache-airflow-providers-celery 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://old-panda.com/posts/airflow-performance-tuning/" >记一次 Airflow 性能调优 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow-providers-celery/stable/celery_executor.html" >Celery Executor — apache-airflow-providers-celery Documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/375666107" >高性能分布式任务队列Celery功能探究 - 知乎 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.ac.cn/docs/helm-chart/stable/manage-dags-files.html" >管理 DAG 文件 — helm-chart 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.org.cn/docs/apache-airflow/stable/core-concepts/executor/index.html#executor-types" >Executor — Airflow 文档 - Airflow 工作流管理平台 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html#std-setting-worker_consumer_poll_interval" >Configuration and defaults — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/search?q=repo:apache/airflow+TaskInstance&type=code" >Code search results <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://airflow.apache.org/docs/apache-airflow/stable/howto/usage-cli.html" >Using the Command Line Interface — Airflow Documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/index.html" >Celery - Distributed Task Queue — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1805994" >任务队列神器：Celery 入门到进阶指南-腾讯云开发者社区-腾讯云 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/optimizing.html" >Optimizing — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/concurrency/index.html" >Concurrency — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/stable/userguide/configuration.html" >Configuration and defaults — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.zhihu.com/tardis/zm/art/133391977?source_id=1005" >Kubeflow-K8S的机器学习工具包，太牛了！ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2317882" >从零搭建机器学习平台Kubeflow-腾讯云开发者社区-腾讯云 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/airflow/blob/570e0b9eceef21c061277163c409adba81b9033a/chart/docs/production-guide.rst#L636" >airflow&#x2F;chart&#x2F;docs&#x2F;production-guide.rst at 570e0b9eceef21c061277163c409adba81b9033a · apache&#x2F;airflow <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/latest/getting-started/backends-and-brokers/index.html#broker-overview" >Backends and Brokers — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/latest/getting-started/backends-and-brokers/redis.html#broker-redis" >Using Redis — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://docs.celeryq.dev/en/latest/getting-started/backends-and-brokers/rabbitmq.html" >Using RabbitMQ — Celery 5.5.2 documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/airflow/discussions/29619" >Airflow Workers Trying to Create Pods in Default Namespace · apache&#x2F;airflow · Discussion #29619 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.techiescamp.com/docs/pods-is-forbidden-error/" >[Solved] pods is forbidden: User system:serviceaccount cannot list resource <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/AIRFLOW/Airflow+3.0" >Airflow 3.0 - Airflow - Apache Software Foundation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/airflow/discussions/26564" >Multiple LocalExecutors on HA Scheduler deployment? · apache&#x2F;airflow · Discussion #26564 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.astronomer.io/docs/learn/2.x/airflow-executors-explained/?tab=traditional#run-multiple-executors-concurrently" >Apache Airflow® Executors | Astronomer Documentation <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/airflow/issues/48667" >Task execution failure with multiple executors · Issue #48667 · apache&#x2F;airflow <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/airflow/pull/49433/files" >Change default executor in pod template to support executor parameter in task (re-uploaded) by ihnokim · Pull Request #49433 · apache&#x2F;airflow <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/apache/airflow/blob/main/chart/files/pod-template-file.kubernetes-helm-yaml#L96" >airflow&#x2F;chart&#x2F;files&#x2F;pod-template-file.kubernetes-helm-yaml at main · apache&#x2F;airflow <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> airflow optimizing</li>
        <li><strong>Author:</strong> Ethereal</li>
        <li><strong>Created at:</strong> 2025-05-08 17:21:54</li>
        
            <li>
                <strong>Updated at:</strong> 2025-05-22 19:27:58
            </li>
        
        <li>
            <strong>Link:</strong> https://ethereal-o.github.io/2025/05/08/airflow-optimizing/
        </li>
        <li>
            <strong>License:</strong> This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>.
        </li>
    </ul>
</div>

                </div>
            

            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/2025/05/11/%E7%A6%81%E6%AD%A2mail%E8%87%AA%E5%8A%A8%E6%9B%B4%E6%96%B0/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">禁止mail自动更新</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/2025/04/24/dynamo-learning/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">dynamo learning</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
                <div class="comment-container">
                    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fa-solid fa-comments"></i>&nbsp;Comments
    </div>
    

        
            
 
    <div id="waline"></div>
    <script type="module"  data-pjax>
        import { init } from 'https://evan.beee.top/js/waline.mjs';

        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://example.example.com',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
            });
        }

        if ('true') {
            const loadWalineTimeout = setTimeout(() => {
                loadWaline();
                clearTimeout(loadWalineTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadWaline);
        }
        
    </script>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">airflow optimizing</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%B0%83%E5%BA%A6%E4%BC%98%E5%8C%96"><span class="nav-text">1. 调度优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3"><span class="nav-text">1.1 概念理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E6%B5%8B%E8%AF%95%E5%88%86%E6%9E%90"><span class="nav-text">1.2 测试分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%B0%9D%E8%AF%95%E4%BC%98%E5%8C%96"><span class="nav-text">1.3 尝试优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%AF%B9%E6%AF%94%E9%80%89%E5%9E%8B"><span class="nav-text">1.4 对比选型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Celery%E4%BC%98%E5%8C%96"><span class="nav-text">1.5 Celery优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>
            
            

        </div>

        <div class="main-content-footer">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2023</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Ethereal</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br>
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.2.1</a>
        </div>
        
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    


</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/layouts/navbarShrink.js"></script>

<script src="/js/tools/scrollTopBottom.js"></script>

<script src="/js/tools/lightDarkSwitch.js"></script>





    
<script src="/js/tools/codeBlock.js"></script>




    
<script src="/js/layouts/lazyload.js"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js"></script>







<div class="post-scripts pjax">
    
        
<script src="/js/tools/tocToggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/layouts/toc.js"></script>

<script src="/js/plugins/tabs.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax',
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            Global.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            Global.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            Global.refresh();
        });
    });
</script>




</body>
</html>
